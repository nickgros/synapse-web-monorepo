import{R as E,r as m}from"./index-8db94870.js";import{aJ as w,aB as M,bs as T,bt as C,aC as R,G as Q,u as l,z as b,n as v,bu as F}from"./SynapseClient-2be0d786.js";import{u as p}from"./useMutation-04744998.js";import{_ as K}from"./inheritsLoose-c82a83d4.js";import{u as q}from"./useInfiniteQuery-46979ab7.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-d057b0e6.js";import{p as G,o as P}from"./pick-de3f9fba.js";var x=function(t){K(n,t);function n(s,e){var r;return r=t.call(this)||this,r.client=s,r.queries=[],r.result=[],r.observers=[],r.observersMap={},e&&r.setQueries(e),r}var u=n.prototype;return u.onSubscribe=function(){var e=this;this.listeners.length===1&&this.observers.forEach(function(r){r.subscribe(function(i){e.onUpdate(r,i)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(e){e.destroy()})},u.setQueries=function(e,r){this.queries=e,this.updateObservers(r)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(e){return this.findMatchingObservers(e).map(function(r){return r.observer.getOptimisticResult(r.defaultedQueryOptions)})},u.findMatchingObservers=function(e){var r=this,i=this.observers,a=e.map(function(y){return r.client.defaultQueryObserverOptions(y)}),f=a.flatMap(function(y){var h=i.find(function(g){return g.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),c=f.map(function(y){return y.defaultedQueryOptions.queryHash}),d=a.filter(function(y){return!c.includes(y.queryHash)}),S=i.filter(function(y){return!f.some(function(h){return h.observer===y})}),o=d.map(function(y,h){if(y.keepPreviousData){var g=S[h];if(g!==void 0)return{defaultedQueryOptions:y,observer:g}}return{defaultedQueryOptions:y,observer:r.getObserver(y)}}),O=function(h,g){return a.indexOf(h.defaultedQueryOptions)-a.indexOf(g.defaultedQueryOptions)};return f.concat(o).sort(O)},u.getObserver=function(e){var r=this.client.defaultQueryObserverOptions(e),i=this.observersMap[r.queryHash];return i??new w(this.client,r)},u.updateObservers=function(e){var r=this;M.batch(function(){var i=r.observers,a=r.findMatchingObservers(r.queries);a.forEach(function(o){return o.observer.setOptions(o.defaultedQueryOptions,e)});var f=a.map(function(o){return o.observer}),c=Object.fromEntries(f.map(function(o){return[o.options.queryHash,o]})),d=f.map(function(o){return o.getCurrentResult()}),S=f.some(function(o,O){return o!==i[O]});i.length===f.length&&!S||(r.observers=f,r.observersMap=c,r.result=d,r.hasListeners()&&(T(i,f).forEach(function(o){o.destroy()}),T(f,i).forEach(function(o){o.subscribe(function(O){r.onUpdate(o,O)})}),r.notify()))})},u.onUpdate=function(e,r){var i=this.observers.indexOf(e);i!==-1&&(this.result=C(this.result,i,r),this.notify())},u.notify=function(){var e=this;M.batch(function(){e.listeners.forEach(function(r){r(e.result)})})},n}(R);function A(t){var n=E.useRef(!1),u=E.useState(0),s=u[1],e=Q(),r=m.useMemo(function(){return t.map(function(c){var d=e.defaultQueryObserverOptions(c);return d.optimisticResults=!0,d})},[t,e]),i=E.useState(function(){return new x(e,r)}),a=i[0],f=a.getOptimisticResult(r);return E.useEffect(function(){n.current=!0;var c=a.subscribe(M.batchCalls(function(){n.current&&s(function(d){return d+1})}));return function(){n.current=!1,c()}},[a]),E.useEffect(function(){a.setQueries(r,{listeners:!1})},[r,a]),f}function k(t,n,u){return t.invalidateQueries(n.getEntityQueryKey(u))}function z(t,n,u){const{accessToken:s,keyFactory:e}=l();return b(e.getEntityVersionQueryKey(t,n),()=>v.getEntity(s,t,n==null?void 0:n.toString()),u)}function j(t,n){const{accessToken:u,keyFactory:s}=l(),e=t.map(c=>c.id).join(),r=m.useMemo(()=>t.map(c=>({queryKey:s.getEntityVersionQueryKey(c.id,c.versionNumber),queryFn:()=>v.getEntity(u,c.id,c.versionNumber)})),[e]),i=A(r),a=i.some(c=>c.isLoading),f=i.filter(c=>c.data!==void 0).map(c=>c.data);return m.useMemo(()=>(!a&&(n!=null&&n.onSuccess)&&n.onSuccess(f),{isLoading:a,data:f}),[a,e])}function W(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(e=>v.updateEntity(e,u),{...t,onSuccess:async(e,r,i)=>{await k(n,s,e.id),n.setQueryData(s.getEntityQueryKey(e.id),e),t!=null&&t.onSuccess&&await t.onSuccess(e,r,i)}})}function X(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(e=>v.deleteEntity(u,e),{...t,onSuccess:async(e,r,i)=>{await k(n,s,r),t!=null&&t.onSuccess&&await t.onSuccess(e,r,i)}})}function Y(t,n){const{accessToken:s,keyFactory:e}=l();return q(e.getEntityVersionsQueryKey(t),async r=>await v.getEntityVersions(t,s,r.pageParam,200),{...n,getNextPageParam:(r,i)=>{if(r.results.length>0)return i.length*200}})}function L(t){return G(t,F[t.concreteType])}function U(t){return P(t,F[t.concreteType])}function Z(t,n){const{accessToken:u,keyFactory:s}=l(),e=b(s.getEntityJsonQueryKey(t),()=>v.getEntityJson(t,u),n),r=m.useMemo(()=>(e==null?void 0:e.data)==null?void 0:L(e.data),[e.data]),i=m.useMemo(()=>(e==null?void 0:e.data)==null?void 0:U(e.data),[e.data]);return{...e,entityMetadata:r,annotations:i}}function N(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(e=>{const r=e.id;return v.updateEntityJson(r,e,u)},{...t,onSuccess:async(e,r,i)=>{const a=e.id;await k(n,s,a),n.setQueryData(s.getEntityJsonQueryKey(a),e),t!=null&&t.onSuccess&&await t.onSuccess(e,r,i)}})}function ee(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(t),()=>v.getEntityPath(t,u),n)}function te(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(t),()=>v.getEntityACL(t,u),n)}function re(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(t),()=>v.getEntityAlias(t,u),n)}function ne(t,n,u){const{accessToken:s,keyFactory:e}=l();return b(e.getEntityEvaluationsQueryKey(t),()=>v.getAllEntityEvaluations(t,n,s),u)}function se(t,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(t),()=>v.getEntityPermissions(t,u),n)}function ue(t){const n=Q(),{accessToken:u,keyFactory:s}=l();return p(e=>v.updateEntityACL(e,u),{...t,onSuccess:async(e,r,i)=>{await k(n,s,e.id),n.setQueryData(s.getEntityACLQueryKey(e.id),e),t!=null&&t.onSuccess&&await t.onSuccess(e,r,i)}})}export{Z as a,ee as b,W as c,j as d,ne as e,ue as f,re as g,te as h,k as i,se as j,X as k,Y as l,N as m,z as u};
//# sourceMappingURL=useEntity-01ef9709.js.map
