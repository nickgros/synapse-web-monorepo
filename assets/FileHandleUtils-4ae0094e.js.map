{"version":3,"file":"FileHandleUtils-4ae0094e.js","sources":["../../src/utils/functions/FileHandleUtils.ts"],"sourcesContent":["import {\n  EntityBundle,\n  EntityType,\n  EXTERNAL_FILE_HANDLE_CONCRETE_TYPE_VALUE,\n  EXTERNAL_OBJECT_STORE_FILE_HANDLE_CONCRETE_TYPE_VALUE,\n  ExternalFileHandle,\n  ExternalObjectStoreFileHandle,\n  FileEntity,\n  FileHandle,\n  GOOGLE_CLOUD_FILE_HANDLE_CONCRETE_TYPE_VALUE,\n  GoogleCloudFileHandle,\n  PROXY_FILE_HANDLE_CONCRETE_TYPE_VALUE,\n  ProxyFileHandle,\n  S3_FILE_HANDLE_CONCRETE_TYPE_VALUE,\n  S3FileHandle,\n} from '@sage-bionetworks/synapse-types'\nimport {\n  ExternalGoogleCloudUploadDestination,\n  ExternalObjectStoreUploadDestination,\n  ExternalS3UploadDestination,\n  ExternalUploadDestination,\n  UploadDestination,\n  UploadType,\n} from '@sage-bionetworks/synapse-types'\n\nconst SYNAPSE_STORAGE = 'Synapse Storage'\nconst SYNAPSE_STORAGE_LOCATION_ID = 1\n\ntype FileHandleStorageInfo =\n  | {\n      endpoint: string\n      bucket: string\n      fileKey: string\n    }\n  | { url: string }\n  | { location: string }\n\n/**\n * Returns storage location information for a particular file handle, where the format of the information depends on the type of file handle.\n * @param fileHandle\n */\nexport function getFileHandleStorageInfo(\n  fileHandle: FileHandle,\n): FileHandleStorageInfo {\n  switch (fileHandle.concreteType) {\n    case EXTERNAL_OBJECT_STORE_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return {\n        endpoint: (fileHandle as ExternalObjectStoreFileHandle).endpointUrl,\n        bucket: (fileHandle as ExternalObjectStoreFileHandle).bucket,\n        fileKey: (fileHandle as ExternalObjectStoreFileHandle).fileKey,\n      }\n    case PROXY_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n    case EXTERNAL_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return { url: getStorageLocationName(fileHandle) }\n    case S3_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n    case GOOGLE_CLOUD_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return {\n        location: getStorageLocationName(fileHandle),\n      }\n    default:\n      throw new Error(\n        `Couldn't determine location name for file handle: ${JSON.stringify(\n          fileHandle,\n        )}`,\n      )\n  }\n}\n\n/**\n * Gets the friendly name of a bucket/storage location using the file handle.\n *\n * @param fileHandle\n * @returns\n */\nexport function getStorageLocationName(fileHandle: FileHandle) {\n  switch (fileHandle.concreteType) {\n    case PROXY_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return (fileHandle as ProxyFileHandle).filePath\n    case EXTERNAL_OBJECT_STORE_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return (fileHandle as ExternalObjectStoreFileHandle).bucket\n    case EXTERNAL_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return (fileHandle as ExternalFileHandle).externalURL\n    case S3_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      // Uploads to Synapse Storage often do not get their storage location field back-filled,\n      // so null also indicates a Synapse-Stored file\n      if (\n        [null, SYNAPSE_STORAGE_LOCATION_ID].includes(\n          (fileHandle as S3FileHandle).storageLocationId,\n        )\n      ) {\n        return SYNAPSE_STORAGE\n      } else {\n        return `s3://${(fileHandle as S3FileHandle).bucketName}`\n      }\n    case GOOGLE_CLOUD_FILE_HANDLE_CONCRETE_TYPE_VALUE:\n      return `gs://${(fileHandle as GoogleCloudFileHandle).bucketName}`\n    default:\n      throw new Error(\n        `Couldn't determine location name for file handle: ${JSON.stringify(\n          fileHandle,\n        )}`,\n      )\n  }\n}\n\n/**\n * Gets the data file handle from an entity bundle.\n * Returns undefined if the entity does not have a data file handle that is visible to the caller.\n * @param entityBundle\n */\nexport function getDataFileHandle(\n  entityBundle: EntityBundle,\n): FileHandle | undefined {\n  let dataFileHandle = undefined\n  if (entityBundle.entityType === EntityType.FILE) {\n    dataFileHandle = entityBundle.fileHandles.filter(\n      fh => fh.id === (entityBundle.entity as FileEntity).dataFileHandleId,\n    )[0]\n  }\n  return dataFileHandle\n}\n\nexport function getUploadDestinationString(\n  uploadDestination: UploadDestination,\n) {\n  let uploadDestinationString = null\n  if (uploadDestination) {\n    switch (uploadDestination.concreteType) {\n      case 'org.sagebionetworks.repo.model.file.S3UploadDestination':\n        uploadDestinationString = SYNAPSE_STORAGE\n        break\n      case 'org.sagebionetworks.repo.model.file.ExternalUploadDestination':\n        uploadDestinationString = (\n          uploadDestination as ExternalUploadDestination\n        ).url\n        if (uploadDestination.uploadType === UploadType.SFTP) {\n          const indexOfLastSlash = uploadDestinationString.lastIndexOf('/')\n          if (indexOfLastSlash) {\n            uploadDestinationString = uploadDestinationString.substring(\n              0,\n              indexOfLastSlash,\n            )\n          }\n        }\n        break\n      case 'org.sagebionetworks.repo.model.file.ExternalS3UploadDestination':\n        uploadDestinationString =\n          's3://' +\n          (uploadDestination as ExternalS3UploadDestination).bucket +\n          '/'\n        if (\n          (uploadDestination as ExternalS3UploadDestination).baseKey != null\n        ) {\n          uploadDestinationString += (\n            uploadDestination as ExternalS3UploadDestination\n          ).baseKey\n        }\n        break\n      case 'org.sagebionetworks.repo.model.file.ExternalGoogleCloudUploadDestination':\n        uploadDestinationString =\n          'gs://' +\n          (uploadDestination as ExternalGoogleCloudUploadDestination).bucket +\n          '/'\n        if (\n          (uploadDestination as ExternalGoogleCloudUploadDestination).baseKey !=\n          null\n        ) {\n          uploadDestinationString += (\n            uploadDestination as ExternalGoogleCloudUploadDestination\n          ).baseKey\n        }\n        break\n      case 'org.sagebionetworks.repo.model.file.ExternalObjectStoreUploadDestination':\n        uploadDestinationString =\n          (uploadDestination as ExternalObjectStoreUploadDestination)\n            .endpointUrl +\n          '/' +\n          (uploadDestination as ExternalObjectStoreUploadDestination).bucket\n        break\n    }\n  }\n  return uploadDestinationString\n}\n"],"names":["SYNAPSE_STORAGE","SYNAPSE_STORAGE_LOCATION_ID","getFileHandleStorageInfo","fileHandle","EXTERNAL_OBJECT_STORE_FILE_HANDLE_CONCRETE_TYPE_VALUE","PROXY_FILE_HANDLE_CONCRETE_TYPE_VALUE","EXTERNAL_FILE_HANDLE_CONCRETE_TYPE_VALUE","getStorageLocationName","S3_FILE_HANDLE_CONCRETE_TYPE_VALUE","GOOGLE_CLOUD_FILE_HANDLE_CONCRETE_TYPE_VALUE","getDataFileHandle","entityBundle","dataFileHandle","EntityType","fh","getUploadDestinationString","uploadDestination","uploadDestinationString","UploadType","indexOfLastSlash"],"mappings":"+FAyBA,MAAMA,EAAkB,kBAClBC,EAA8B,EAe7B,SAASC,EACdC,EACuB,CACvB,OAAQA,EAAW,aAAc,CAC/B,KAAKC,EACI,MAAA,CACL,SAAWD,EAA6C,YACxD,OAASA,EAA6C,OACtD,QAAUA,EAA6C,OAAA,EAE3D,KAAKE,EACL,KAAKC,EACH,MAAO,CAAE,IAAKC,EAAuBJ,CAAU,CAAE,EACnD,KAAKK,EACL,KAAKC,EACI,MAAA,CACL,SAAUF,EAAuBJ,CAAU,CAAA,EAE/C,QACE,MAAM,IAAI,MACR,qDAAqD,KAAK,UACxDA,CAAA,GACF,CAEN,CACF,CAQO,SAASI,EAAuBJ,EAAwB,CAC7D,OAAQA,EAAW,aAAc,CAC/B,KAAKE,EACH,OAAQF,EAA+B,SACzC,KAAKC,EACH,OAAQD,EAA6C,OACvD,KAAKG,EACH,OAAQH,EAAkC,YAC5C,KAAKK,EAID,MAAA,CAAC,KAAMP,CAA2B,EAAE,SACjCE,EAA4B,iBAAA,EAGxBH,EAEA,QAASG,EAA4B,aAEhD,KAAKM,EACH,MAAO,QAASN,EAAqC,aACvD,QACE,MAAM,IAAI,MACR,qDAAqD,KAAK,UACxDA,CAAA,GACF,CAEN,CACF,CAOO,SAASO,EACdC,EACwB,CACxB,IAAIC,EACA,OAAAD,EAAa,aAAeE,EAAW,OACzCD,EAAiBD,EAAa,YAAY,OAClCG,GAAAA,EAAG,KAAQH,EAAa,OAAsB,kBACpD,CAAC,GAEEC,CACT,CAEO,SAASG,EACdC,EACA,CACA,IAAIC,EAA0B,KAC9B,GAAID,EACF,OAAQA,EAAkB,aAAc,CACtC,IAAK,0DACuBC,EAAAjB,EAC1B,MACF,IAAK,gEAIC,GAHJiB,EACED,EACA,IACEA,EAAkB,aAAeE,EAAW,KAAM,CAC9C,MAAAC,EAAmBF,EAAwB,YAAY,GAAG,EAC5DE,IACFF,EAA0BA,EAAwB,UAChD,EACAE,CAAA,GAIN,MACF,IAAK,kEAEDF,EAAA,QACCD,EAAkD,OACnD,IAECA,EAAkD,SAAW,OAE9DC,GACED,EACA,SAEJ,MACF,IAAK,2EAEDC,EAAA,QACCD,EAA2D,OAC5D,IAECA,EAA2D,SAC5D,OAEAC,GACED,EACA,SAEJ,MACF,IAAK,2EAEAC,EAAAD,EACE,YACH,IACCA,EAA2D,OAC9D,KACJ,CAEK,OAAAC,CACT"}