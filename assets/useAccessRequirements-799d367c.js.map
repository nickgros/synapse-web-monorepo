{"version":3,"file":"useAccessRequirements-799d367c.js","sources":["../../src/lib/containers/AccessRequirementList/AccessRequirementListUtils.ts","../../src/lib/utils/hooks/SynapseAPI/dataaccess/useAccessRequirements.ts"],"sourcesContent":["import { sortBy } from 'lodash-es'\nimport { getAccessRequirementStatus } from '../../utils/SynapseClient'\n\n/**\n * Given an array of access requirement IDs, return the IDs sorted by the user's status, where\n * completed access requirements are shown first.\n * @param accessToken\n * @param requirementIds\n */\nexport const sortAccessRequirementsByCompletion = async (\n  accessToken: string | undefined,\n  requirementIds: string[],\n): Promise<string[]> => {\n  const statuses = requirementIds.map(id => {\n    return getAccessRequirementStatus(accessToken, id)\n  })\n  const accessRequirementStatuses = await Promise.all(statuses)\n\n  return sortBy(requirementIds, id => {\n    // if its true then it should come first, which means that it should be higher in the list\n    // which is sorted ascendingly\n    return (\n      -1 *\n      Number(\n        accessRequirementStatuses.find(\n          status => id === status.accessRequirementId,\n        )!.isApproved,\n      )\n    )\n  })\n}\n","import {\n  useInfiniteQuery,\n  UseInfiniteQueryOptions,\n  useMutation,\n  UseMutationOptions,\n  useQuery,\n  useQueryClient,\n  UseQueryOptions,\n} from 'react-query'\nimport { SynapseClient } from '../../..'\nimport { SynapseClientError } from '../../../SynapseClientError'\nimport { useSynapseContext } from '../../../SynapseContext'\nimport {\n  AccessApproval,\n  AccessControlList,\n  AccessRequirement,\n  AccessRequirementStatus,\n  ACTSubmissionStatus,\n  ManagedACTAccessRequirementStatus,\n  Renewal,\n  Request,\n  RestrictionInformationRequest,\n  RestrictionInformationResponse,\n  WikiPageKey,\n} from '../../../synapseTypes'\nimport {\n  AccessRequirementSearchRequest,\n  AccessRequirementSearchResponse,\n} from '../../../synapseTypes/AccessRequirement/AccessRequirementSearch'\nimport { ResearchProject } from '../../../synapseTypes/ResearchProject'\nimport { sortAccessRequirementsByCompletion } from '../../../../containers/AccessRequirementList/AccessRequirementListUtils'\n\nexport function useGetAccessRequirements<T extends AccessRequirement>(\n  accessRequirementId: string | number,\n  options?: UseQueryOptions<T, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n  return useQuery<T, SynapseClientError>(\n    keyFactory.getAccessRequirementQueryKey(String(accessRequirementId)),\n    () =>\n      SynapseClient.getAccessRequirementById<T>(\n        accessToken,\n        accessRequirementId,\n      ),\n    options,\n  )\n}\n\nexport function useGetAccessRequirementsForEntity(\n  entityId: string,\n  options?: UseQueryOptions<AccessRequirement[], SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n  return useQuery<AccessRequirement[], SynapseClientError>(\n    keyFactory.getEntityAccessRequirementsQueryKey(entityId),\n    () => SynapseClient.getAllAccessRequirements(accessToken, entityId),\n    options,\n  )\n}\n\nexport function useGetAccessRequirementsForTeam(\n  teamId: string,\n  options?: UseQueryOptions<AccessRequirement[], SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n  return useQuery<AccessRequirement[], SynapseClientError>(\n    keyFactory.getTeamAccessRequirementsQueryKey(teamId),\n    () => SynapseClient.getTeamAccessRequirements(accessToken, teamId),\n    options,\n  )\n}\n\nexport function useGetAccessRequirementWikiPageKey(\n  accessRequirementId: string,\n  options?: UseQueryOptions<WikiPageKey, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n  return useQuery<WikiPageKey, SynapseClientError>(\n    keyFactory.getAccessRequirementWikiPageKey(accessRequirementId),\n    () =>\n      SynapseClient.getWikiPageKeyForAccessRequirement(\n        accessToken,\n        accessRequirementId,\n      ),\n    options,\n  )\n}\n\nexport function useGetAccessRequirementACL(\n  accessRequirementId: string,\n  options?: UseQueryOptions<AccessControlList | null, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n\n  return useQuery<AccessControlList | null, SynapseClientError>(\n    keyFactory.getAccessRequirementAclQueryKey(accessRequirementId),\n    () =>\n      SynapseClient.getAccessRequirementAcl(accessToken, accessRequirementId),\n    options,\n  )\n}\n\nexport function useSearchAccessRequirementsInfinite(\n  params: Omit<AccessRequirementSearchRequest, 'nextPageToken'>,\n  options?: UseInfiniteQueryOptions<\n    AccessRequirementSearchResponse,\n    SynapseClientError\n  >,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n  return useInfiniteQuery<AccessRequirementSearchResponse, SynapseClientError>(\n    keyFactory.searchAccessRequirementsQueryKey(params),\n    async context => {\n      return await SynapseClient.searchAccessRequirements(accessToken, {\n        ...params,\n        nextPageToken: context.pageParam,\n      })\n    },\n    {\n      ...options,\n      getNextPageParam: page => page.nextPageToken,\n    },\n  )\n}\n\nexport function useGetRestrictionInformation(\n  request: RestrictionInformationRequest,\n  options?: UseQueryOptions<RestrictionInformationResponse, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n\n  return useQuery<RestrictionInformationResponse, SynapseClientError>(\n    keyFactory.getAccessRequirementRestrictionInformationQueryKey(request),\n    () => SynapseClient.getRestrictionInformation(request, accessToken),\n    options,\n  )\n}\n\nexport function useCreateLockAccessRequirement(\n  options?: UseMutationOptions<AccessRequirement, SynapseClientError, string>,\n) {\n  const { accessToken } = useSynapseContext()\n  const queryClient = useQueryClient()\n  const { keyFactory } = useSynapseContext()\n\n  return useMutation<AccessRequirement, SynapseClientError, string>({\n    ...options,\n    mutationFn: (entityId: string) =>\n      SynapseClient.createLockAccessRequirement(entityId, accessToken),\n    mutationKey: ['createLockAccessRequirement'],\n    onSuccess: async (data, variables, ctx) => {\n      // Invalidate all access requirement queries\n      await queryClient.invalidateQueries(\n        keyFactory.getAccessRequirementQueryKey(),\n      )\n      // Invalidate all entity queries (not just the current entity because the new AR may apply to this entity's children)\n      await queryClient.invalidateQueries(keyFactory.getAllEntityDataQueryKey())\n      if (options?.onSuccess) {\n        return options.onSuccess(data, variables, ctx)\n      }\n    },\n  })\n}\n\nexport function useGetAccessRequirementStatus<\n  T extends\n    | AccessRequirementStatus\n    | ManagedACTAccessRequirementStatus = AccessRequirementStatus,\n>(\n  accessRequirementId: string,\n  options?: UseQueryOptions<T, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n\n  return useQuery<T, SynapseClientError>(\n    keyFactory.getAccessRequirementStatusQueryKey(accessRequirementId),\n    () =>\n      SynapseClient.getAccessRequirementStatus<T>(\n        accessToken,\n        accessRequirementId,\n      ),\n    options,\n  )\n}\n\nexport function useSortAccessRequirementIdsByCompletion(\n  accessRequirementIds: string[],\n  options?: UseQueryOptions<string[], SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n\n  return useQuery<string[], SynapseClientError>(\n    keyFactory.getSortedAccessRequirementsAndStatusQueryKey(\n      accessRequirementIds,\n    ),\n    () => sortAccessRequirementsByCompletion(accessToken, accessRequirementIds),\n    options,\n  )\n}\n\nexport function useGetResearchProject(\n  accessRequirementId: string,\n  options?: UseQueryOptions<ResearchProject, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n\n  return useQuery<ResearchProject, SynapseClientError>(\n    keyFactory.getAccessRequirementResearchProjectQueryKey(accessRequirementId),\n    () => SynapseClient.getResearchProject(accessRequirementId, accessToken!),\n    options,\n  )\n}\n\nexport function useUpdateResearchProject(\n  options?: UseMutationOptions<\n    ResearchProject,\n    SynapseClientError,\n    ResearchProject\n  >,\n) {\n  const { accessToken } = useSynapseContext()\n  const queryClient = useQueryClient()\n  const { keyFactory } = useSynapseContext()\n\n  return useMutation<ResearchProject, SynapseClientError, ResearchProject>(\n    (researchProject: ResearchProject) =>\n      SynapseClient.updateResearchProject(researchProject, accessToken!),\n    {\n      ...options,\n      onSuccess: async (data, variables, ctx) => {\n        // Invalidate the research project query\n        await queryClient.invalidateQueries(\n          keyFactory.getAccessRequirementResearchProjectQueryKey(\n            data.accessRequirementId,\n          ),\n        )\n        if (options?.onSuccess) {\n          return options.onSuccess(data, variables, ctx)\n        }\n      },\n    },\n  )\n}\n\nexport function useGetDataAccessRequestForUpdate(\n  accessRequirementId: string,\n  options?: UseQueryOptions<Request | Renewal, SynapseClientError>,\n) {\n  const { accessToken, keyFactory } = useSynapseContext()\n\n  return useQuery<Request | Renewal, SynapseClientError>(\n    keyFactory.getDataAccessRequestForUpdateQueryKey(accessRequirementId),\n    () =>\n      SynapseClient.getDataAccessRequestForUpdate(\n        accessRequirementId,\n        accessToken!,\n      ),\n    options,\n  )\n}\n\nexport function useUpdateDataAccessRequest(\n  options?: UseMutationOptions<\n    Request | Renewal,\n    SynapseClientError,\n    Request | Renewal\n  >,\n) {\n  const { accessToken } = useSynapseContext()\n  const queryClient = useQueryClient()\n  const { keyFactory } = useSynapseContext()\n\n  return useMutation<Request | Renewal, SynapseClientError, Request | Renewal>(\n    (requestInterface: Request | Renewal) =>\n      SynapseClient.updateDataAccessRequest(requestInterface, accessToken!),\n    {\n      ...options,\n      onSuccess: async (data, variables, ctx) => {\n        // Invalidate the data access request query\n        await queryClient.invalidateQueries(\n          keyFactory.getDataAccessRequestForUpdateQueryKey(\n            data.accessRequirementId,\n          ),\n        )\n        if (options?.onSuccess) {\n          return options.onSuccess(data, variables, ctx)\n        }\n      },\n    },\n  )\n}\n\nexport function useCreateAccessApproval(\n  options?: UseMutationOptions<\n    AccessApproval,\n    SynapseClientError,\n    AccessApproval\n  >,\n) {\n  const { accessToken } = useSynapseContext()\n  const queryClient = useQueryClient()\n  const { keyFactory } = useSynapseContext()\n\n  return useMutation<AccessApproval, SynapseClientError, AccessApproval>(\n    request => SynapseClient.createAccessApproval(accessToken, request),\n    {\n      ...options,\n      onSuccess: async (data, variables, ctx) => {\n        // Invalidate query for AR status\n        await queryClient.invalidateQueries(\n          keyFactory.getAccessRequirementStatusQueryKey(\n            String(variables.requirementId),\n          ),\n        )\n        if (options?.onSuccess) {\n          return options.onSuccess(data, variables, ctx)\n        }\n      },\n    },\n  )\n}\n\nexport function useCancelDataAccessRequest(\n  options?: UseMutationOptions<\n    ACTSubmissionStatus,\n    SynapseClientError,\n    { submissionId: string; accessRequirementId: string }\n  >,\n) {\n  const { accessToken } = useSynapseContext()\n  const queryClient = useQueryClient()\n  const { keyFactory } = useSynapseContext()\n\n  return useMutation<\n    ACTSubmissionStatus,\n    SynapseClientError,\n    { submissionId: string; accessRequirementId: string }\n  >(\n    request =>\n      SynapseClient.cancelDataAccessRequest(request.submissionId, accessToken!),\n    {\n      ...options,\n      onSuccess: async (data, variables, ctx) => {\n        // Invalidate query for AR status\n        await queryClient.invalidateQueries(\n          keyFactory.getAccessRequirementStatusQueryKey(\n            String(variables.accessRequirementId),\n          ),\n        )\n        if (options?.onSuccess) {\n          return options.onSuccess(data, variables, ctx)\n        }\n      },\n    },\n  )\n}\n"],"names":["sortAccessRequirementsByCompletion","accessToken","requirementIds","statuses","id","getAccessRequirementStatus","accessRequirementStatuses","sortBy","status","useGetAccessRequirements","accessRequirementId","options","keyFactory","useSynapseContext","useQuery","SynapseClient.getAccessRequirementById","useGetAccessRequirementsForEntity","entityId","SynapseClient.getAllAccessRequirements","useGetAccessRequirementsForTeam","teamId","SynapseClient.getTeamAccessRequirements","useGetAccessRequirementWikiPageKey","SynapseClient.getWikiPageKeyForAccessRequirement","useGetAccessRequirementACL","SynapseClient.getAccessRequirementAcl","useSearchAccessRequirementsInfinite","params","useInfiniteQuery","context","SynapseClient.searchAccessRequirements","page","useGetRestrictionInformation","request","SynapseClient.getRestrictionInformation","useCreateLockAccessRequirement","queryClient","useQueryClient","useMutation","SynapseClient.createLockAccessRequirement","data","variables","ctx","useGetAccessRequirementStatus","SynapseClient.getAccessRequirementStatus","useSortAccessRequirementIdsByCompletion","accessRequirementIds","useGetResearchProject","SynapseClient.getResearchProject","useUpdateResearchProject","researchProject","SynapseClient.updateResearchProject","useGetDataAccessRequestForUpdate","SynapseClient.getDataAccessRequestForUpdate","useUpdateDataAccessRequest","requestInterface","SynapseClient.updateDataAccessRequest","useCreateAccessApproval","SynapseClient.createAccessApproval","useCancelDataAccessRequest","SynapseClient.cancelDataAccessRequest"],"mappings":"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"}