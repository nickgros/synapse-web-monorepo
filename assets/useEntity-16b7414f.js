import{R as M,r as k}from"./index-76fb7be0.js";import{an as P,af as C,bb as S,bc as U,ag as x,r as g,bd as A,o as d,s as b,t as m,be as q}from"./SynapseClient-7700f4cc.js";import{u as O}from"./useMutation-2249482e.js";import{_ as G}from"./inheritsLoose-c82a83d4.js";import{u as _}from"./useInfiniteQuery-7e752e07.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-c0eacdfc.js";import"./jsx-runtime-9dc53467.js";import{i as I}from"./isEqualWith-7a8dbfc5.js";import{a as w}from"./isArray-5e3f9107.js";import{i as T}from"./_Map-02912bad.js";import{i as F,o as R,p as L,a as J}from"./pick-89ddd0c3.js";import{g as D}from"./InfiniteQueryUtils-54ae7e6b.js";var H=function(e){G(r,e);function r(s,n){var t;return t=e.call(this)||this,t.client=s,t.queries=[],t.result=[],t.observers=[],t.observersMap={},n&&t.setQueries(n),t}var u=r.prototype;return u.onSubscribe=function(){var n=this;this.listeners.length===1&&this.observers.forEach(function(t){t.subscribe(function(a){n.onUpdate(t,a)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(n){n.destroy()})},u.setQueries=function(n,t){this.queries=n,this.updateObservers(t)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(n){return this.findMatchingObservers(n).map(function(t){return t.observer.getOptimisticResult(t.defaultedQueryOptions)})},u.findMatchingObservers=function(n){var t=this,a=this.observers,o=n.map(function(y){return t.client.defaultQueryObserverOptions(y)}),f=o.flatMap(function(y){var h=a.find(function(E){return E.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),i=f.map(function(y){return y.defaultedQueryOptions.queryHash}),c=o.filter(function(y){return!i.includes(y.queryHash)}),v=a.filter(function(y){return!f.some(function(h){return h.observer===y})}),l=c.map(function(y,h){if(y.keepPreviousData){var E=v[h];if(E!==void 0)return{defaultedQueryOptions:y,observer:E}}return{defaultedQueryOptions:y,observer:t.getObserver(y)}}),p=function(h,E){return o.indexOf(h.defaultedQueryOptions)-o.indexOf(E.defaultedQueryOptions)};return f.concat(l).sort(p)},u.getObserver=function(n){var t=this.client.defaultQueryObserverOptions(n),a=this.observersMap[t.queryHash];return a??new P(this.client,t)},u.updateObservers=function(n){var t=this;C.batch(function(){var a=t.observers,o=t.findMatchingObservers(t.queries);o.forEach(function(l){return l.observer.setOptions(l.defaultedQueryOptions,n)});var f=o.map(function(l){return l.observer}),i=Object.fromEntries(f.map(function(l){return[l.options.queryHash,l]})),c=f.map(function(l){return l.getCurrentResult()}),v=f.some(function(l,p){return l!==a[p]});a.length===f.length&&!v||(t.observers=f,t.observersMap=i,t.result=c,t.hasListeners()&&(S(a,f).forEach(function(l){l.destroy()}),S(f,a).forEach(function(l){l.subscribe(function(p){t.onUpdate(l,p)})}),t.notify()))})},u.onUpdate=function(n,t){var a=this.observers.indexOf(n);a!==-1&&(this.result=U(this.result,a,t),this.notify())},u.notify=function(){var n=this;C.batch(function(){n.listeners.forEach(function(t){t(n.result)})})},r}(x);function V(e){var r=M.useRef(!1),u=M.useState(0),s=u[1],n=g(),t=k.useMemo(function(){return e.map(function(i){var c=n.defaultQueryObserverOptions(i);return c.optimisticResults=!0,c})},[e,n]),a=M.useState(function(){return new H(n,t)}),o=a[0],f=o.getOptimisticResult(t);return M.useEffect(function(){r.current=!0;var i=o.subscribe(C.batchCalls(function(){r.current&&s(function(c){return c+1})}));return function(){r.current=!1,i()}},[o]),M.useEffect(function(){o.setQueries(t,{listeners:!1})},[t,o]),f}const K=(e,r)=>{if(!(w(e)||w(r))&&!(!T(e)||!T(r))&&!(!F(e,void 0)&&!F(r,void 0)))return I(R(e,u=>u===void 0),R(r,u=>u===void 0),K)};function B(e,r){return I(e,r,K)}function $(e,r){const u=new Set;for(const s of e)u.add(s.id);for(const s of r)if(s.id!=null&&!u.has(s.id))throw new Error(`Proposed schema contains a new column model with ID ${s.id} that is not in the old schema.`)}async function j(e,r,u,s){$(u,s);const n=new Map;for(const i of u)n.set(i.id,i);let t=[];for(const i of s){const c={...i};if(c.id!=null){const v=n.get(c.id);v!=null&&!B(v,c)&&delete c.id}t.push(c)}const a=(await A(e,t)).list,o=[],f=new Set;for(let i=0;i<s.length;i++){const c=s[i].id??null,v=a[i].id;c!=null&&f.add(c),f.add(v),c!=null&&c!==v?o.push({oldColumnId:c,newColumnId:v}):c==null&&o.push({oldColumnId:null,newColumnId:v})}for(const i of u){const c=i.id;f.has(c)||o.push({oldColumnId:c,newColumnId:null})}return{concreteType:"org.sagebionetworks.repo.model.table.TableUpdateTransactionRequest",entityId:r,changes:[{concreteType:"org.sagebionetworks.repo.model.table.TableSchemaChangeRequest",entityId:r,changes:o,orderedColumnIds:a.map(i=>i.id)}]}}function Q(e,r,u){return e.invalidateQueries(r.getEntityQueryKey(u))}function ce(e,r,u){const{accessToken:s,keyFactory:n}=d();return b(n.getEntityVersionQueryKey(e,r),()=>m.getEntity(s,e,r==null?void 0:r.toString()),u)}function fe(e,r){const{accessToken:u,keyFactory:s}=d(),n=e.map(i=>i.id).join(),t=k.useMemo(()=>e.map(i=>({queryKey:s.getEntityVersionQueryKey(i.id,i.versionNumber),queryFn:()=>m.getEntity(u,i.id,i.versionNumber)})),[n]),a=V(t),o=a.some(i=>i.isLoading),f=a.filter(i=>i.data!==void 0).map(i=>i.data);return k.useMemo(()=>(!o&&(r!=null&&r.onSuccess)&&r.onSuccess(f),{isLoading:o,data:f}),[o,n])}function le(e){const r=g(),{accessToken:u,keyFactory:s}=d();return O(n=>m.createEntity(n,u),{onSuccess:async(n,t,a)=>{await Q(r,s,n.id),r.setQueryData(s.getEntityQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function ye(e){const r=g(),{accessToken:u,keyFactory:s}=d();return O(n=>m.updateEntity(n,u),{...e,onSuccess:async(n,t,a)=>{await Q(r,s,n.id),r.setQueryData(s.getEntityQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function de(e){const r=g(),{accessToken:u,keyFactory:s}=d();return O(n=>m.deleteEntity(u,n),{...e,onSuccess:async(n,t,a)=>{await Q(r,s,t),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function me(e,r){const{accessToken:s,keyFactory:n}=d();return _(n.getEntityVersionsQueryKey(e),async t=>await m.getEntityVersions(e,s,t.pageParam,200),{...r,getNextPageParam:D})}function W(e){return L(e,q[e.concreteType])}function z(e){return J(e,q[e.concreteType])}function ve(e,r,u){const{accessToken:s,keyFactory:n}=d(),t=b(n.getEntityJsonQueryKey(e,r),()=>m.getEntityJson(e,r,s),u),a=k.useMemo(()=>(t==null?void 0:t.data)==null?void 0:W(t.data),[t.data]),o=k.useMemo(()=>(t==null?void 0:t.data)==null?void 0:z(t.data),[t.data]);return{...t,entityMetadata:a,annotations:o}}function he(e){const r=g(),{accessToken:u,keyFactory:s}=d();return O(n=>{const t=n.id;return m.updateEntityJson(t,n,u)},{...e,onSuccess:async(n,t,a)=>{const o=n.id;await Q(r,s,o),r.setQueryData(s.getEntityJsonQueryKey(o,!1),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function ge(e,r){const{accessToken:u,keyFactory:s}=d();return b(s.getEntityPathQueryKey(e),()=>m.getEntityPath(e,u),r)}function be(e,r){const{accessToken:u,keyFactory:s}=d();return b(s.getEntityPathQueryKey(e),()=>m.getEntityACL(e,u),r)}function Ee(e,r){const{accessToken:u,keyFactory:s}=d();return b(s.getEntityAliasQueryKey(e),()=>m.getEntityAlias(e,u),r)}function Oe(e,r,u){const{accessToken:s,keyFactory:n}=d();return b(n.getEntityEvaluationsQueryKey(e),()=>m.getAllEntityEvaluations(e,r,s),u)}function Qe(e,r){const{accessToken:u,keyFactory:s}=d();return b(s.getEntityAliasQueryKey(e),()=>m.getEntityPermissions(e,u),r)}function pe(e){const r=g(),{accessToken:u,keyFactory:s}=d();return O(n=>m.updateEntityACL(n,u),{...e,onSuccess:async(n,t,a)=>{await Q(r,s,n.id),r.setQueryData(s.getEntityACLQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function Me(e){const r=g(),{accessToken:u,keyFactory:s}=d();return O(async n=>{const t=await j(u,n.entityId,n.originalColumnModels,n.newColumnModels);return m.updateTable(t,u)},{...e,onSuccess:async(n,t,a)=>{await Q(r,s,t.entityId),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}export{Me as a,ge as b,ye as c,ve as d,le as e,fe as f,Oe as g,pe as h,Q as i,Ee as j,be as k,Qe as l,he as m,de as n,me as o,ce as u};
