import{R as M,r as k}from"./index-76fb7be0.js";import{_ as P,ar as U,af as C,bd as S,be as x,ag as A,y as g,bf as G,m as d,x as b,s as m,bg as q}from"./SynapseClient-d7905674.js";import{u as O}from"./useMutation-caf08e9c.js";import{u as _}from"./useInfiniteQuery-8fa1c35b.js";import"./getEndpoint-ac94413e.js";import"./OrientationBanner-1bd00e8c.js";import"./jsx-runtime-9dc53467.js";import{i as I}from"./isEqualWith-2aee5e03.js";import{a as w}from"./isArray-5e3f9107.js";import{i as T}from"./_Map-02912bad.js";import{i as F,o as R,p as L,a as J}from"./pick-f7c80597.js";import{g as D}from"./InfiniteQueryUtils-54ae7e6b.js";var H=function(e){P(s,e);function s(r,n){var t;return t=e.call(this)||this,t.client=r,t.queries=[],t.result=[],t.observers=[],t.observersMap={},n&&t.setQueries(n),t}var u=s.prototype;return u.onSubscribe=function(){var n=this;this.listeners.length===1&&this.observers.forEach(function(t){t.subscribe(function(a){n.onUpdate(t,a)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(n){n.destroy()})},u.setQueries=function(n,t){this.queries=n,this.updateObservers(t)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(n){return this.findMatchingObservers(n).map(function(t){return t.observer.getOptimisticResult(t.defaultedQueryOptions)})},u.findMatchingObservers=function(n){var t=this,a=this.observers,o=n.map(function(y){return t.client.defaultQueryObserverOptions(y)}),f=o.flatMap(function(y){var h=a.find(function(E){return E.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),i=f.map(function(y){return y.defaultedQueryOptions.queryHash}),c=o.filter(function(y){return!i.includes(y.queryHash)}),v=a.filter(function(y){return!f.some(function(h){return h.observer===y})}),l=c.map(function(y,h){if(y.keepPreviousData){var E=v[h];if(E!==void 0)return{defaultedQueryOptions:y,observer:E}}return{defaultedQueryOptions:y,observer:t.getObserver(y)}}),p=function(h,E){return o.indexOf(h.defaultedQueryOptions)-o.indexOf(E.defaultedQueryOptions)};return f.concat(l).sort(p)},u.getObserver=function(n){var t=this.client.defaultQueryObserverOptions(n),a=this.observersMap[t.queryHash];return a??new U(this.client,t)},u.updateObservers=function(n){var t=this;C.batch(function(){var a=t.observers,o=t.findMatchingObservers(t.queries);o.forEach(function(l){return l.observer.setOptions(l.defaultedQueryOptions,n)});var f=o.map(function(l){return l.observer}),i=Object.fromEntries(f.map(function(l){return[l.options.queryHash,l]})),c=f.map(function(l){return l.getCurrentResult()}),v=f.some(function(l,p){return l!==a[p]});a.length===f.length&&!v||(t.observers=f,t.observersMap=i,t.result=c,t.hasListeners()&&(S(a,f).forEach(function(l){l.destroy()}),S(f,a).forEach(function(l){l.subscribe(function(p){t.onUpdate(l,p)})}),t.notify()))})},u.onUpdate=function(n,t){var a=this.observers.indexOf(n);a!==-1&&(this.result=x(this.result,a,t),this.notify())},u.notify=function(){var n=this;C.batch(function(){n.listeners.forEach(function(t){t(n.result)})})},s}(A);function V(e){var s=M.useRef(!1),u=M.useState(0),r=u[1],n=g(),t=k.useMemo(function(){return e.map(function(i){var c=n.defaultQueryObserverOptions(i);return c.optimisticResults=!0,c})},[e,n]),a=M.useState(function(){return new H(n,t)}),o=a[0],f=o.getOptimisticResult(t);return M.useEffect(function(){s.current=!0;var i=o.subscribe(C.batchCalls(function(){s.current&&r(function(c){return c+1})}));return function(){s.current=!1,i()}},[o]),M.useEffect(function(){o.setQueries(t,{listeners:!1})},[t,o]),f}const K=(e,s)=>{if(!(w(e)||w(s))&&!(!T(e)||!T(s))&&!(!F(e,void 0)&&!F(s,void 0)))return I(R(e,u=>u===void 0),R(s,u=>u===void 0),K)};function B(e,s){return I(e,s,K)}function $(e,s){const u=new Set;for(const r of e)u.add(r.id);for(const r of s)if(r.id!=null&&!u.has(r.id))throw new Error(`Proposed schema contains a new column model with ID ${r.id} that is not in the old schema.`)}async function j(e,s,u,r){$(u,r);const n=new Map;for(const i of u)n.set(i.id,i);let t=[];for(const i of r){const c={...i};if(c.id!=null){const v=n.get(c.id);v!=null&&!B(v,c)&&delete c.id}t.push(c)}const a=(await G(e,t)).list,o=[],f=new Set;for(let i=0;i<r.length;i++){const c=r[i].id??null,v=a[i].id;c!=null&&f.add(c),f.add(v),c!=null&&c!==v?o.push({oldColumnId:c,newColumnId:v}):c==null&&o.push({oldColumnId:null,newColumnId:v})}for(const i of u){const c=i.id;f.has(c)||o.push({oldColumnId:c,newColumnId:null})}return{concreteType:"org.sagebionetworks.repo.model.table.TableUpdateTransactionRequest",entityId:s,changes:[{concreteType:"org.sagebionetworks.repo.model.table.TableSchemaChangeRequest",entityId:s,changes:o,orderedColumnIds:a.map(i=>i.id)}]}}function Q(e,s,u){return e.invalidateQueries(s.getEntityQueryKey(u))}function oe(e,s,u){const{accessToken:r,keyFactory:n}=d();return b(n.getEntityVersionQueryKey(e,s),()=>m.getEntity(r,e,s==null?void 0:s.toString()),u)}function ce(e,s){const{accessToken:u,keyFactory:r}=d(),n=e.map(i=>i.id).join(),t=k.useMemo(()=>e.map(i=>({queryKey:r.getEntityVersionQueryKey(i.id,i.versionNumber),queryFn:()=>m.getEntity(u,i.id,i.versionNumber)})),[n]),a=V(t),o=a.some(i=>i.isLoading),f=a.filter(i=>i.data!==void 0).map(i=>i.data);return k.useMemo(()=>(!o&&(s!=null&&s.onSuccess)&&s.onSuccess(f),{isLoading:o,data:f}),[o,n])}function fe(e){const s=g(),{accessToken:u,keyFactory:r}=d();return O(n=>m.createEntity(n,u),{onSuccess:async(n,t,a)=>{await Q(s,r,n.id),s.setQueryData(r.getEntityQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function le(e){const s=g(),{accessToken:u,keyFactory:r}=d();return O(n=>m.updateEntity(n,u),{...e,onSuccess:async(n,t,a)=>{await Q(s,r,n.id),s.setQueryData(r.getEntityQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function ye(e){const s=g(),{accessToken:u,keyFactory:r}=d();return O(n=>m.deleteEntity(u,n),{...e,onSuccess:async(n,t,a)=>{await Q(s,r,t),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function de(e,s){const{accessToken:r,keyFactory:n}=d();return _(n.getEntityVersionsQueryKey(e),async t=>await m.getEntityVersions(e,r,t.pageParam,200),{...s,getNextPageParam:D})}function W(e){return L(e,q[e.concreteType])}function z(e){return J(e,q[e.concreteType])}function me(e,s,u){const{accessToken:r,keyFactory:n}=d(),t=b(n.getEntityJsonQueryKey(e,s),()=>m.getEntityJson(e,s,r),u),a=k.useMemo(()=>(t==null?void 0:t.data)==null?void 0:W(t.data),[t.data]),o=k.useMemo(()=>(t==null?void 0:t.data)==null?void 0:z(t.data),[t.data]);return{...t,entityMetadata:a,annotations:o}}function ve(e){const s=g(),{accessToken:u,keyFactory:r}=d();return O(n=>{const t=n.id;return m.updateEntityJson(t,n,u)},{...e,onSuccess:async(n,t,a)=>{const o=n.id;await Q(s,r,o),s.setQueryData(r.getEntityJsonQueryKey(o,!1),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function he(e,s){const{accessToken:u,keyFactory:r}=d();return b(r.getEntityPathQueryKey(e),()=>m.getEntityPath(e,u),s)}function ge(e,s){const{accessToken:u,keyFactory:r}=d();return b(r.getEntityPathQueryKey(e),()=>m.getEntityACL(e,u),s)}function be(e,s){const{accessToken:u,keyFactory:r}=d();return b(r.getEntityAliasQueryKey(e),()=>m.getEntityAlias(e,u),s)}function Ee(e,s,u){const{accessToken:r,keyFactory:n}=d();return b(n.getEntityEvaluationsQueryKey(e),()=>m.getAllEntityEvaluations(e,s,r),u)}function Oe(e,s){const{accessToken:u,keyFactory:r}=d();return b(r.getEntityAliasQueryKey(e),()=>m.getEntityPermissions(e,u),s)}function Qe(e){const s=g(),{accessToken:u,keyFactory:r}=d();return O(n=>m.updateEntityACL(n,u),{...e,onSuccess:async(n,t,a)=>{await Q(s,r,n.id),s.setQueryData(r.getEntityACLQueryKey(n.id),n),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}function pe(e){const s=g(),{accessToken:u,keyFactory:r}=d();return O(async n=>{const t=await j(u,n.entityId,n.originalColumnModels,n.newColumnModels);return m.updateTable(t,u)},{...e,onSuccess:async(n,t,a)=>{await Q(s,r,t.entityId),e!=null&&e.onSuccess&&await e.onSuccess(n,t,a)}})}export{pe as a,he as b,le as c,me as d,fe as e,ce as f,Ee as g,Qe as h,Q as i,be as j,ge as k,Oe as l,ve as m,ye as n,de as o,oe as u};
//# sourceMappingURL=useEntity-87581b86.js.map
