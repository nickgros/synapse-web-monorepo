import{r as _,R as v}from"./index-76fb7be0.js";import{x as Y,y as ce,z as pe,k as me,C as $,H as ge}from"./SynapseConstants-8157454e.js";import{s as w}from"./SynapseClient-d7905674.js";import{u as j}from"./useMutation-caf08e9c.js";import{g as ee,B as te}from"./getEndpoint-ac94413e.js";import{j as u,a as A,F as z}from"./jsx-runtime-9dc53467.js";import{F as fe}from"./FullWidthAlert-a8fd2235.js";import{s as Oe}from"./styled-2fcfc37a.js";import{T as Ee}from"./TextField-603e6176.js";import{B as D}from"./Box-2044d34a.js";import{B as G}from"./Button-8ea9f590.js";import{T as b}from"./TextField-38c47b70.js";import{L as V}from"./Link-66bc2a10.js";import{L as F}from"./LoginMethodButton-adb50a59.js";import{I as he}from"./IconSvg-f8ded0ba.js";import{I as _e}from"./IconButton-64077c25.js";function $e(t,o){const[a,r]=_.useState("CHOOSE_AUTH_METHOD"),[c,n]=_.useState(),[l,p]=_.useState(),[g,m]=_.useState();_.useEffect(()=>{const i=new URL(window.location.href.replaceAll("#","/")),{searchParams:f}=i;if(f){const E=f.get("userId"),S=f.get("twoFaToken");E&&S&&(p(parseInt(E,10)),m(S),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(a)||r("VERIFICATION_CODE"))}},[a]),_.useEffect(()=>{o&&(m(o.twoFaToken),p(o.userId),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(a)||r("VERIFICATION_CODE"))},[o]),_.useEffect(()=>{n(void 0)},[a]);async function C(i){await w.setAccessTokenCookie(i.accessToken),localStorage.setItem(Y,i.authenticationReceipt),r("LOGGED_IN"),t&&t()}const{mutate:O,isLoading:y}=j(({username:i,password:f,authenticationReceipt:E})=>w.login(i,f,E),{onError:i=>{n(i.reason)},onSuccess:async i=>{i&&("errorCode"in i?(r("VERIFICATION_CODE"),m(i.twoFaToken),p(i.userId)):await C(i))}}),{mutate:T,isLoading:L}=j(w.loginWith2fa,{onError:i=>{n(i.reason),(i.reason.includes("The provided twoFaToken is invalid")||i.reason.includes("Token has expired"))&&(console.warn(i),n("Something went wrong. Refresh the page and try again."),window.location.href.includes("twoFaToken")&&window.history.replaceState({},document.title,window.location.href.replaceAll(/(twoFaToken|userId)=[^&]*&?/g,"")))},onSuccess:C});return{step:a,onStepChange:r,submitUsernameAndPassword:(i,f)=>{n(void 0);const E=localStorage.getItem(Y);O({username:i,password:f,authenticationReceipt:E})},submitOneTimePassword:(i,f=a==="RECOVERY_CODE"?"RECOVERY_CODE":"TOTP")=>{if(n(void 0),g==null||l==null){n("You did not first log in with your password or a third-party identity provider.");return}T({userId:l,twoFaToken:g,otpCode:i,otpType:f})},errorMessage:c,isLoading:y||L}}const Ce=Oe(Ee)`
  input {
    text-align: center;
  }
`,ye={TextFieldStyled:Ce},Re=t=>u(ye.TextFieldStyled,{...t}),P={left:"ArrowLeft",right:"ArrowRight",backspace:"Backspace"};function Se(t,o){return t<=0?[]:Array.from({length:t},o)}function Ae(t,o,a){return t.map((r,c)=>o===c?a:r)}function K(t){return t.join("")}function J(t,o){return[...t,o]}function Te(t,o,a){return t.reduce((r,c,n)=>{const{characters:l,restArrayMerged:p}=r;if(n<a)return{restArrayMerged:p,characters:J(l,c)};const[g,...m]=p;return{restArrayMerged:m,characters:J(l,g||"")}},{restArrayMerged:o,characters:[]}).characters}function Ie(t){return t.split("")}const ne=v.forwardRef((t,o)=>{const{value:a,length:r,autoFocus:c,onChange:n,TextFieldsProps:l,onComplete:p,validateChar:g,className:m,...C}=t,{onPaste:O,onFocus:y,onKeyDown:T,className:L,...B}=l||{},R=Se(r,(e,d)=>({character:a[d]||"",inputRef:v.createRef()})),i=e=>R.findIndex(({inputRef:d})=>d.current===e),f=()=>R.map(({character:e})=>e),E=(e,d)=>{const s=Ae(f(),e,d);return K(s)},S=e=>{var d,s;(s=(d=R[e])==null?void 0:d.inputRef.current)==null||s.focus()},I=e=>{var d,s;(s=(d=R[e])==null?void 0:d.inputRef.current)==null||s.select()},U=e=>{e+1!==r&&(R[e+1].character?I(e+1):S(e+1))},re=e=>{e>0&&I(e-1)},oe=e=>{const d=e.target.value[0]||"",s=i(e.target);if(typeof g=="function"&&!g(d,s))return;const h=E(s,d);n==null||n(h),h.length===r&&(p==null||p(h)),d!==""?h.length<r?U(h.length-1):U(s):h[s]?I(s):re(s)},ae=e=>{e.preventDefault(),e.target.select(),y==null||y(e)},ie=e=>{const d=e.target,s=i(d);d.value===e.key?(e.preventDefault(),U(s)):!d.value&&P.backspace===e.key||P.left===e.key?(e.preventDefault(),I(s-1)):P.right===e.key&&(e.preventDefault(),I(s+1)),T==null||T(e)},se=e=>{e.preventDefault();const d=e.target,s=e.clipboardData.getData("text/plain"),h=i(d),ue=f(),q=Te(ue,Ie(s),h),W=q.findIndex((le,de)=>de>h&&le===""),N=K(q);if(n==null||n(N),N.length===r){p==null||p(N),S(r-1);return}W!==-1&&S(W),O==null||O(e)};return u(D,{display:"flex",gap:"20px",alignItems:"center",ref:o,className:`MuiOtpInput-Box ${m||""}`,...C,children:R.map(({character:e,inputRef:d},s)=>u(Re,{autoFocus:c?s===0:!1,autoComplete:"one-time-code",value:e,inputRef:d,className:`MuiOtpInput-TextField MuiOtpInput-TextField-${s+1} ${L||""}`,onPaste:se,onFocus:ae,onChange:oe,onKeyDown:ie,...B},s))})});ne.defaultProps={value:"",length:4,autoFocus:!1,validateChar:()=>!0,onChange:()=>{},onComplete:()=>{},TextFieldsProps:{}};const Q=6,we=["0","1","2","3","4","5","6","7","8","9"];function M(t){const{onSubmit:o,isLoading:a}=t,[r,c]=v.useState("");return A(D,{children:[u(ne,{autoFocus:!0,length:Q,value:r,onChange:c,onComplete:o,validateChar:n=>we.includes(n)||n==="",gap:"2px",sx:{".MuiInputBase-root":{paddingLeft:"5px",paddingRight:"5px"},".MuiFormControl-root:first-of-type > .MuiInputBase-root":{borderTopRightRadius:0,borderBottomRightRadius:0},".MuiFormControl-root:last-of-type > .MuiInputBase-root":{borderTopLeftRadius:0,borderBottomLeftRadius:0},".MuiFormControl-root:not(:first-of-type):not(:last-of-type) > .MuiInputBase-root":{borderRadius:0}}}),u(G,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:r.length!==Q||a,onClick:n=>{n.preventDefault(),o(r)},children:a?"Verifying...":"Submit"})]})}try{M.displayName="TOTPForm",M.__docgenInfo={description:"",displayName:"TOTPForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function x(t){const{resetPasswordUrl:o=`${ee(te.PORTAL_ENDPOINT)}#!PasswordReset:0`,onSubmit:a,isLoading:r}=t,[c,n]=_.useState(""),[l,p]=_.useState("");function g(m){m.preventDefault(),a(c,l)}return A("form",{onSubmit:m=>{g(m)},children:[u(b,{required:!0,fullWidth:!0,autoFocus:!0,autoComplete:"username",label:"Username or Email Address",id:"username",type:"text",value:c,onChange:m=>n(m.target.value)}),u(b,{required:!0,fullWidth:!0,autoComplete:"current-password",label:"Password",id:"current-password",type:"password",value:l,onChange:m=>p(m.target.value)}),u(V,{href:o,children:"Forgot password?"}),u(G,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",disabled:r,sx:{height:"50px",mt:4,mb:2},children:r?"Logging you in...":"Sign in"})]})}try{x.displayName="UsernamePasswordForm",x.__docgenInfo={description:"",displayName:"UsernamePasswordForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(username: string, password: string) => void"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function H(t){const{onBeginOAuthSignIn:o,ssoRedirectUrl:a,onSelectUsernameAndPassword:r}=t;function c(n,l){o&&o(),n.preventDefault();const p=a?`${a}${l}`:`${w.getRootURL()}?provider=${l}`;w.oAuthUrlRequest(l,p).then(g=>{window.location=g.authorizationUrl}).catch(g=>{console.log("Error on oAuth url ",g)})}return A(D,{children:[u(F,{loginMethod:ce,iconName:"google24",onClick:n=>{c(n,$.GOOGLE)}}),u(F,{loginMethod:pe,iconName:"orcid",onClick:n=>{c(n,$.ORCID)}}),u(F,{loginMethod:me,iconName:"email",onClick:r})]})}try{H.displayName="AuthenticationMethodSelection",H.__docgenInfo={description:`To support Google SSO in your portal, you must add your domain to the Authorized Redirect URIs for Synapse authentication.
This can be done by visiting https://sagebionetworks.jira.com/servicedesk/customer/portal/9 to set up a collaboration.
Synapse engineers must add your redirect URL in the Google API console found at https://console.cloud.google.com/ for this functionality to work.`,displayName:"AuthenticationMethodSelection",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},onSelectUsernameAndPassword:{defaultValue:null,description:"",name:"onSelectUsernameAndPassword",required:!0,type:{name:"() => void"}}}}}catch{}const De=19;function k(t){const{onSubmit:o,isLoading:a}=t,[r,c]=v.useState("");return A(D,{children:[u(b,{placeholder:"Enter backup code",value:r,onChange:n=>{const l=n.target.value.toLowerCase().replace(/[^a-z0-9-]/gi,"");c(l)}}),u(G,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:r.length!==De||a,onClick:n=>{n.preventDefault(),o(r)},children:a?"Verifying...":"Submit"})]})}try{k.displayName="RecoveryCodeForm",k.__docgenInfo={description:"",displayName:"RecoveryCodeForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function X(t){const{ssoRedirectUrl:o,registerAccountUrl:a=`${ee(te.PORTAL_ENDPOINT)}#!RegisterAccount:0`,resetPasswordUrl:r,onBeginOAuthSignIn:c,onStepChange:n,step:l,submitUsernameAndPassword:p,submitOneTimePassword:g,errorMessage:m,isLoading:C}=t;return A(z,{children:[l=="CHOOSE_AUTH_METHOD"&&u(H,{onSelectUsernameAndPassword:()=>n("USERNAME_PASSWORD"),onBeginOAuthSignIn:c,ssoRedirectUrl:o}),l==="USERNAME_PASSWORD"&&u(x,{isLoading:C,resetPasswordUrl:r,onSubmit:(O,y)=>{p(O,y)}}),l==="VERIFICATION_CODE"&&A(z,{children:[u(M,{isLoading:C,onSubmit:O=>{g(O,"TOTP")}}),u(V,{align:"center",color:"grey.700",sx:{display:"block",mx:"auto"},onClick:()=>n("RECOVERY_CODE"),children:"Use a backup code instead"})]}),l==="RECOVERY_CODE"&&u(k,{isLoading:C,onSubmit:O=>{g(O,"RECOVERY_CODE")}}),(l==="CHOOSE_AUTH_METHOD"||l==="USERNAME_PASSWORD")&&u(D,{sx:{display:"flex",justifyContent:"center",mt:"10px"},children:u(V,{href:a,align:"center",children:"Don't have an account? Create one now"})}),m&&u(fe,{variant:"warning",isGlobal:!1,description:m})]})}try{X.displayName="LoginForm",X.__docgenInfo={description:"",displayName:"LoginForm",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},registerAccountUrl:{defaultValue:null,description:"",name:"registerAccountUrl",required:!1,type:{name:"string"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},twoFactorAuthenticationRequired:{defaultValue:null,description:"",name:"twoFactorAuthenticationRequired",required:!1,type:{name:"TwoFactorAuthErrorResponse"}},submitUsernameAndPassword:{defaultValue:null,description:"",name:"submitUsernameAndPassword",required:!0,type:{name:"(username: string, password: string) => void"}},submitOneTimePassword:{defaultValue:null,description:"",name:"submitOneTimePassword",required:!0,type:{name:"(code: string, otpType?: TwoFactorAuthOtpType | undefined) => void"}},errorMessage:{defaultValue:null,description:"",name:"errorMessage",required:!0,type:{name:"string | undefined"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function ve(t){switch(t){case"CHOOSE_AUTH_METHOD":return"CHOOSE_AUTH_METHOD";case"USERNAME_PASSWORD":return"CHOOSE_AUTH_METHOD";case"VERIFICATION_CODE":return"CHOOSE_AUTH_METHOD";case"RECOVERY_CODE":return"VERIFICATION_CODE";case"LOGGED_IN":return"LOGGED_IN"}}function Z(t){const{step:o,onStepChange:a,sx:r}=t;return o==="USERNAME_PASSWORD"||o==="VERIFICATION_CODE"||o==="RECOVERY_CODE"?u(_e,{className:ge,type:"button",onClick:()=>{a(ve(o))},sx:r,children:u(he,{icon:"arrowBack",wrap:!1,sx:{height:"24px",width:"24px"}})}):null}try{Z.displayName="LoginFlowBackButton",Z.__docgenInfo={description:"",displayName:"LoginFlowBackButton",props:{step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},sx:{defaultValue:null,description:"",name:"sx",required:!1,type:{name:"SxProps"}}}}}catch{}export{Z as L,X as a,$e as u};
//# sourceMappingURL=LoginFlowBackButton-f0aa4e6c.js.map
