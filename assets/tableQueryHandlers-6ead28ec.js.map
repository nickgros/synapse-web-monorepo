{"version":3,"file":"tableQueryHandlers-6ead28ec.js","sources":["../../src/mocks/msw/handlers/tableQueryHandlers.ts"],"sourcesContent":["import { cloneDeep, uniqueId } from 'lodash-es'\nimport { rest } from 'msw'\nimport {\n  ASYNCHRONOUS_JOB_TOKEN,\n  TABLE_QUERY_ASYNC_GET,\n  TABLE_QUERY_ASYNC_START,\n} from '../../../utils/APIConstants'\nimport {\n  BackendDestinationEnum,\n  getEndpoint,\n} from '../../../utils/functions/getEndpoint'\nimport {\n  BUNDLE_MASK_LAST_UPDATED_ON,\n  BUNDLE_MASK_QUERY_COLUMN_MODELS,\n  BUNDLE_MASK_QUERY_COUNT,\n  BUNDLE_MASK_QUERY_FACETS,\n  BUNDLE_MASK_QUERY_MAX_ROWS_PER_PAGE,\n  BUNDLE_MASK_QUERY_RESULTS,\n  BUNDLE_MASK_QUERY_SELECT_COLUMNS,\n  BUNDLE_MASK_SUM_FILES_SIZE_BYTES,\n} from '../../../utils/SynapseConstants'\nimport {\n  AsynchronousJobStatus,\n  AsyncJobId,\n  QueryBundleRequest,\n  QueryResultBundle,\n} from '@sage-bionetworks/synapse-types'\n\nconst BIT_TO_FIELD_MAP: Record<number, keyof QueryResultBundle> = {\n  [BUNDLE_MASK_QUERY_RESULTS]: 'queryResult',\n  [BUNDLE_MASK_QUERY_COUNT]: 'queryCount',\n  [BUNDLE_MASK_QUERY_SELECT_COLUMNS]: 'selectColumns',\n  [BUNDLE_MASK_QUERY_MAX_ROWS_PER_PAGE]: 'maxRowsPerPage',\n  [BUNDLE_MASK_QUERY_COLUMN_MODELS]: 'columnModels',\n  [BUNDLE_MASK_QUERY_FACETS]: 'facets',\n  [BUNDLE_MASK_SUM_FILES_SIZE_BYTES]: 'sumFileSizes',\n  [BUNDLE_MASK_LAST_UPDATED_ON]: 'lastUpdatedOn',\n}\n\nfunction removeBundleFieldsUsingMask(\n  queryResultBundle: QueryResultBundle,\n  partMask: number,\n): QueryResultBundle {\n  const result = cloneDeep(queryResultBundle)\n  Object.entries(BIT_TO_FIELD_MAP).forEach(([bit, field]) => {\n    if ((partMask & parseInt(bit)) === 0) {\n      delete result[field]\n    }\n  })\n  return result\n}\n\nexport function getHandlersForTableQuery(\n  response: QueryResultBundle,\n  backendOrigin = getEndpoint(BackendDestinationEnum.REPO_ENDPOINT),\n) {\n  // We must map generated async job IDs to requests to disambiguate multiple calls to these endpoints\n  const mapOfRequests = new Map<string, QueryBundleRequest>()\n\n  return [\n    rest.post(\n      `${backendOrigin}${TABLE_QUERY_ASYNC_START(':id')}`,\n      async (req, res, ctx) => {\n        const asyncJobId = uniqueId()\n        mapOfRequests.set(asyncJobId, await req.json())\n        return res(\n          ctx.status(201),\n          ctx.json<AsyncJobId>({\n            token: asyncJobId,\n          }),\n        )\n      },\n    ),\n\n    rest.get(\n      `${backendOrigin}${ASYNCHRONOUS_JOB_TOKEN(':id')}`,\n      async (req, res, ctx) => {\n        const id = req.params.id as string\n        const queryBundleRequest = mapOfRequests.get(id)\n        if (!id || !queryBundleRequest) {\n          return res(\n            ctx.status(404),\n            ctx.json({ message: 'The mocked asynchronous job was not found' }),\n          )\n        }\n\n        const resultBundle = removeBundleFieldsUsingMask(\n          response,\n          queryBundleRequest.partMask,\n        )\n\n        return res(\n          ctx.status(201),\n          ctx.json<\n            AsynchronousJobStatus<QueryBundleRequest, QueryResultBundle>\n          >({\n            jobState: 'COMPLETE',\n            jobCanceling: false,\n            requestBody: queryBundleRequest,\n            etag: '00000000-0000-0000-0000-000000000000',\n            jobId: id,\n            responseBody: resultBundle,\n            startedByUserId: 0,\n            startedOn: '',\n            changedOn: '',\n            progressMessage: '',\n            progressCurrent: 100,\n            progressTotal: 100,\n            exception: '',\n            errorMessage: '',\n            errorDetails: '',\n            runtimeMS: 100,\n          }),\n        )\n      },\n    ),\n\n    rest.get(\n      `${backendOrigin}${TABLE_QUERY_ASYNC_GET(':entityId', ':asyncJobToken')}`,\n      async (req, res, ctx) => {\n        const asyncJobToken = req.params.asyncJobToken as string\n        const request = mapOfRequests.get(asyncJobToken)\n        if (!asyncJobToken || !request) {\n          return res(\n            ctx.status(404),\n            ctx.json({ message: 'The mocked asynchronous job was not found' }),\n          )\n        }\n        const resultBundle = removeBundleFieldsUsingMask(\n          response,\n          request.partMask,\n        )\n\n        return res(ctx.status(201), ctx.json<QueryResultBundle>(resultBundle))\n      },\n    ),\n  ]\n}\n"],"names":["BIT_TO_FIELD_MAP","BUNDLE_MASK_QUERY_RESULTS","BUNDLE_MASK_QUERY_COUNT","BUNDLE_MASK_QUERY_SELECT_COLUMNS","BUNDLE_MASK_QUERY_MAX_ROWS_PER_PAGE","BUNDLE_MASK_QUERY_COLUMN_MODELS","BUNDLE_MASK_QUERY_FACETS","BUNDLE_MASK_SUM_FILES_SIZE_BYTES","BUNDLE_MASK_LAST_UPDATED_ON","removeBundleFieldsUsingMask","queryResultBundle","partMask","result","cloneDeep","bit","field","getHandlersForTableQuery","response","backendOrigin","getEndpoint","BackendDestinationEnum","mapOfRequests","rest","TABLE_QUERY_ASYNC_START","req","res","ctx","asyncJobId","uniqueId","ASYNCHRONOUS_JOB_TOKEN","id","queryBundleRequest","resultBundle","TABLE_QUERY_ASYNC_GET","asyncJobToken","request"],"mappings":"yVA4BA,MAAMA,EAA4D,CAChE,CAACC,CAAyB,EAAG,cAC7B,CAACC,CAAuB,EAAG,aAC3B,CAACC,CAAgC,EAAG,gBACpC,CAACC,CAAmC,EAAG,iBACvC,CAACC,CAA+B,EAAG,eACnC,CAACC,CAAwB,EAAG,SAC5B,CAACC,CAAgC,EAAG,eACpC,CAACC,CAA2B,EAAG,eACjC,EAEA,SAASC,EACPC,EACAC,EACmB,CACb,MAAAC,EAASC,EAAUH,CAAiB,EACnC,cAAA,QAAQV,CAAgB,EAAE,QAAQ,CAAC,CAACc,EAAKC,CAAK,IAAM,CACpDJ,EAAW,SAASG,CAAG,GAC1B,OAAOF,EAAOG,CAAK,CACrB,CACD,EACMH,CACT,CAEO,SAASI,EACdC,EACAC,EAAgBC,EAAYC,EAAuB,aAAa,EAChE,CAEM,MAAAC,MAAoB,IAEnB,MAAA,CACLC,EAAAA,KAAK,KACH,GAAGJ,CAAa,GAAGK,EAAwB,KAAK,CAAC,GACjD,MAAOC,EAAKC,EAAKC,IAAQ,CACvB,MAAMC,EAAaC,IACnB,OAAAP,EAAc,IAAIM,EAAY,MAAMH,EAAI,KAAM,CAAA,EACvCC,EACLC,EAAI,OAAO,GAAG,EACdA,EAAI,KAAiB,CACnB,MAAOC,CAAA,CACR,CAAA,CAEL,CACF,EAEAL,EAAAA,KAAK,IACH,GAAGJ,CAAa,GAAGW,EAAuB,KAAK,CAAC,GAChD,MAAOL,EAAKC,EAAKC,IAAQ,CACjB,MAAAI,EAAKN,EAAI,OAAO,GAChBO,EAAqBV,EAAc,IAAIS,CAAE,EAC3C,GAAA,CAACA,GAAM,CAACC,EACH,OAAAN,EACLC,EAAI,OAAO,GAAG,EACdA,EAAI,KAAK,CAAE,QAAS,4CAA6C,CAAA,EAIrE,MAAMM,EAAevB,EACnBQ,EACAc,EAAmB,QAAA,EAGd,OAAAN,EACLC,EAAI,OAAO,GAAG,EACdA,EAAI,KAEF,CACA,SAAU,WACV,aAAc,GACd,YAAaK,EACb,KAAM,uCACN,MAAOD,EACP,aAAcE,EACd,gBAAiB,EACjB,UAAW,GACX,UAAW,GACX,gBAAiB,GACjB,gBAAiB,IACjB,cAAe,IACf,UAAW,GACX,aAAc,GACd,aAAc,GACd,UAAW,GAAA,CACZ,CAAA,CAEL,CACF,EAEAV,EAAAA,KAAK,IACH,GAAGJ,CAAa,GAAGe,EAAsB,YAAa,gBAAgB,CAAC,GACvE,MAAOT,EAAKC,EAAKC,IAAQ,CACjB,MAAAQ,EAAgBV,EAAI,OAAO,cAC3BW,EAAUd,EAAc,IAAIa,CAAa,EAC3C,GAAA,CAACA,GAAiB,CAACC,EACd,OAAAV,EACLC,EAAI,OAAO,GAAG,EACdA,EAAI,KAAK,CAAE,QAAS,4CAA6C,CAAA,EAGrE,MAAMM,EAAevB,EACnBQ,EACAkB,EAAQ,QAAA,EAGH,OAAAV,EAAIC,EAAI,OAAO,GAAG,EAAGA,EAAI,KAAwBM,CAAY,CAAC,CACvE,CACF,CAAA,CAEJ"}