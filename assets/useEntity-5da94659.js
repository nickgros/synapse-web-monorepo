import{R as Q,r as E}from"./index-8db94870.js";import{aJ as q,aB as M,bs as T,bt as w,aC as C,G as m,u as l,z as b,n as v,bu as F}from"./SynapseClient-bd8dfaf3.js";import{u as p}from"./useMutation-e0ea4870.js";import{_ as R}from"./inheritsLoose-c82a83d4.js";import{u as K}from"./useInfiniteQuery-6efeca1f.js";import{_,o as A}from"./pick-90489505.js";var G=function(e){R(n,e);function n(s,t){var r;return r=e.call(this)||this,r.client=s,r.queries=[],r.result=[],r.observers=[],r.observersMap={},t&&r.setQueries(t),r}var u=n.prototype;return u.onSubscribe=function(){var t=this;this.listeners.length===1&&this.observers.forEach(function(r){r.subscribe(function(i){t.onUpdate(r,i)})})},u.onUnsubscribe=function(){this.listeners.length||this.destroy()},u.destroy=function(){this.listeners=[],this.observers.forEach(function(t){t.destroy()})},u.setQueries=function(t,r){this.queries=t,this.updateObservers(r)},u.getCurrentResult=function(){return this.result},u.getOptimisticResult=function(t){return this.findMatchingObservers(t).map(function(r){return r.observer.getOptimisticResult(r.defaultedQueryOptions)})},u.findMatchingObservers=function(t){var r=this,i=this.observers,a=t.map(function(y){return r.client.defaultQueryObserverOptions(y)}),c=a.flatMap(function(y){var h=i.find(function(g){return g.options.queryHash===y.queryHash});return h!=null?[{defaultedQueryOptions:y,observer:h}]:[]}),o=c.map(function(y){return y.defaultedQueryOptions.queryHash}),d=a.filter(function(y){return!o.includes(y.queryHash)}),S=i.filter(function(y){return!c.some(function(h){return h.observer===y})}),f=d.map(function(y,h){if(y.keepPreviousData){var g=S[h];if(g!==void 0)return{defaultedQueryOptions:y,observer:g}}return{defaultedQueryOptions:y,observer:r.getObserver(y)}}),O=function(h,g){return a.indexOf(h.defaultedQueryOptions)-a.indexOf(g.defaultedQueryOptions)};return c.concat(f).sort(O)},u.getObserver=function(t){var r=this.client.defaultQueryObserverOptions(t),i=this.observersMap[r.queryHash];return i??new q(this.client,r)},u.updateObservers=function(t){var r=this;M.batch(function(){var i=r.observers,a=r.findMatchingObservers(r.queries);a.forEach(function(f){return f.observer.setOptions(f.defaultedQueryOptions,t)});var c=a.map(function(f){return f.observer}),o=Object.fromEntries(c.map(function(f){return[f.options.queryHash,f]})),d=c.map(function(f){return f.getCurrentResult()}),S=c.some(function(f,O){return f!==i[O]});i.length===c.length&&!S||(r.observers=c,r.observersMap=o,r.result=d,r.hasListeners()&&(T(i,c).forEach(function(f){f.destroy()}),T(c,i).forEach(function(f){f.subscribe(function(O){r.onUpdate(f,O)})}),r.notify()))})},u.onUpdate=function(t,r){var i=this.observers.indexOf(t);i!==-1&&(this.result=w(this.result,i,r),this.notify())},u.notify=function(){var t=this;M.batch(function(){t.listeners.forEach(function(r){r(t.result)})})},n}(C);function P(e){var n=Q.useRef(!1),u=Q.useState(0),s=u[1],t=m(),r=E.useMemo(function(){return e.map(function(o){var d=t.defaultQueryObserverOptions(o);return d.optimisticResults=!0,d})},[e,t]),i=Q.useState(function(){return new G(t,r)}),a=i[0],c=a.getOptimisticResult(r);return Q.useEffect(function(){n.current=!0;var o=a.subscribe(M.batchCalls(function(){n.current&&s(function(d){return d+1})}));return function(){n.current=!1,o()}},[a]),Q.useEffect(function(){a.setQueries(r,{listeners:!1})},[r,a]),c}function k(e,n,u){return e.invalidateQueries(n.getEntityQueryKey(u))}function B(e,n,u){const{accessToken:s,keyFactory:t}=l();return b(t.getEntityVersionQueryKey(e,n),()=>v.getEntity(s,e,n==null?void 0:n.toString()),u)}function $(e,n){const{accessToken:u,keyFactory:s}=l(),t=e.map(o=>o.id).join(),r=E.useMemo(()=>e.map(o=>({queryKey:s.getEntityVersionQueryKey(o.id,o.versionNumber),queryFn:()=>v.getEntity(u,o.id,o.versionNumber)})),[t]),i=P(r),a=i.some(o=>o.isLoading),c=i.filter(o=>o.data!==void 0).map(o=>o.data);return E.useMemo(()=>(!a&&(n!=null&&n.onSuccess)&&n.onSuccess(c),{isLoading:a,data:c}),[a,t])}function z(e){const n=m(),{accessToken:u,keyFactory:s}=l();return p(t=>v.updateEntity(t,u),{...e,onSuccess:async(t,r,i)=>{await k(n,s,t.id),n.setQueryData(s.getEntityQueryKey(t.id),t),e!=null&&e.onSuccess&&await e.onSuccess(t,r,i)}})}function j(e){const n=m(),{accessToken:u,keyFactory:s}=l();return p(t=>v.deleteEntity(u,t),{...e,onSuccess:async(t,r,i)=>{await k(n,s,r),e!=null&&e.onSuccess&&await e.onSuccess(t,r,i)}})}function W(e,n){const{accessToken:s,keyFactory:t}=l();return K(t.getEntityVersionsQueryKey(e),async r=>await v.getEntityVersions(e,s,r.pageParam,200),{...n,getNextPageParam:(r,i)=>{if(r.results.length>0)return i.length*200}})}function x(e){return _(e,F[e.concreteType])}function L(e){return A(e,F[e.concreteType])}function X(e,n){const[u,s]=E.useState(),[t,r]=E.useState(),{accessToken:i,keyFactory:a}=l(),c=b(a.getEntityJsonQueryKey(e),()=>v.getEntityJson(e,i),n);return E.useEffect(()=>{c.data&&(s(x(c.data)),r(L(c.data)))},[c.data]),{...c,entityMetadata:u,annotations:t}}function Y(e){const n=m(),{accessToken:u,keyFactory:s}=l();return p(t=>{const r=t.id;return v.updateEntityJson(r,t,u)},{...e,onSuccess:async(t,r,i)=>{const a=t.id;await k(n,s,a),n.setQueryData(s.getEntityJsonQueryKey(a),t),e!=null&&e.onSuccess&&await e.onSuccess(t,r,i)}})}function Z(e,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(e),()=>v.getEntityPath(e,u),n)}function N(e,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityPathQueryKey(e),()=>v.getEntityACL(e,u),n)}function ee(e,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(e),()=>v.getEntityAlias(e,u),n)}function te(e,n,u){const{accessToken:s,keyFactory:t}=l();return b(t.getEntityEvaluationsQueryKey(e),()=>v.getAllEntityEvaluations(e,n,s),u)}function re(e,n){const{accessToken:u,keyFactory:s}=l();return b(s.getEntityAliasQueryKey(e),()=>v.getEntityPermissions(e,u),n)}function ne(e){const n=m(),{accessToken:u,keyFactory:s}=l();return p(t=>v.updateEntityACL(t,u),{...e,onSuccess:async(t,r,i)=>{await k(n,s,t.id),n.setQueryData(s.getEntityACLQueryKey(t.id),t),e!=null&&e.onSuccess&&await e.onSuccess(t,r,i)}})}export{X as a,Z as b,z as c,$ as d,te as e,ne as f,ee as g,N as h,k as i,re as j,Y as k,j as l,W as m,B as u};
//# sourceMappingURL=useEntity-5da94659.js.map
