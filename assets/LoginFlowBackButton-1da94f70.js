import{r as _,R as v}from"./index-8db94870.js";import{u as Y,v as ce,m as pe,w as N,x as me}from"./SynapseConstants-76f49806.js";import{n as w}from"./SynapseClient-773213a5.js";import{u as $}from"./useMutation-4f6fea4f.js";import{j as l,a as S,F as j}from"./jsx-runtime-095bf462.js";import{g as ee,B as te}from"./getEndpoint-ac94413e.js";import{F as ge}from"./FullWidthAlert-7a6f936f.js";import{s as fe}from"./styled-96220216.js";import{T as Oe}from"./TextField-46d1fd36.js";import{B as D}from"./Box-891dc3c7.js";import{B as k}from"./Button-d3d5b3a8.js";import{T as b}from"./TextField-fb7b194a.js";import{L as V}from"./Link-9ad54ce1.js";import{L as K}from"./LoginMethodButton-e981ae1e.js";import{I as Ee}from"./IconSvg-fff0cc14.js";import{I as he}from"./IconButton-1e0dd4f6.js";function Ye(t,o){const[a,n]=_.useState("CHOOSE_AUTH_METHOD"),[p,r]=_.useState(),[d,c]=_.useState(),[g,m]=_.useState();_.useEffect(()=>{const i=new URL(window.location.href.replaceAll("#","/")),{searchParams:f}=i;if(f){const E=f.get("userId"),A=f.get("twoFaToken");E&&A&&(c(parseInt(E,10)),m(A),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(a)||n("VERIFICATION_CODE"))}},[a]),_.useEffect(()=>{o&&(m(o.twoFaToken),c(o.userId),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(a)||n("VERIFICATION_CODE"))},[o]),_.useEffect(()=>{r(void 0)},[a]);async function C(i){await w.setAccessTokenCookie(i.accessToken),localStorage.setItem(Y,i.authenticationReceipt),n("LOGGED_IN"),t&&t()}const{mutate:O,isLoading:y}=$(({username:i,password:f,authenticationReceipt:E})=>w.login(i,f,E),{onError:i=>{r(i.reason)},onSuccess:async i=>{"errorCode"in i?(n("VERIFICATION_CODE"),m(i.twoFaToken),c(i.userId)):await C(i)}}),{mutate:T,isLoading:L}=$(w.loginWith2fa,{onError:i=>{r(i.reason),(i.reason.includes("The provided twoFaToken is invalid")||i.reason.includes("Token has expired"))&&(console.warn(i),r("Something went wrong. Refresh the page and try again."),window.location.href.includes("twoFaToken")&&window.history.replaceState({},document.title,window.location.href.replaceAll(/(twoFaToken|userId)=[^&]*&?/g,"")))},onSuccess:C});return{step:a,onStepChange:n,submitUsernameAndPassword:(i,f)=>{r(void 0);const E=localStorage.getItem(Y);O({username:i,password:f,authenticationReceipt:E})},submitOneTimePassword:(i,f=a==="RECOVERY_CODE"?"RECOVERY_CODE":"TOTP")=>{if(r(void 0),g==null||d==null){r("You did not first log in with your password or a third-party identity provider.");return}T({userId:d,twoFaToken:g,otpCode:i,otpType:f})},errorMessage:p,isLoading:y||L}}const _e=fe(Oe)`
  input {
    text-align: center;
  }
`,Ce={TextFieldStyled:_e},ye=t=>l(Ce.TextFieldStyled,{...t}),P={left:"ArrowLeft",right:"ArrowRight",backspace:"Backspace"};function Re(t,o){return t<=0?[]:Array.from({length:t},o)}function Ae(t,o,a){return t.map((n,p)=>o===p?a:n)}function z(t){return t.join("")}function J(t,o){return[...t,o]}function Se(t,o,a){return t.reduce((n,p,r)=>{const{characters:d,restArrayMerged:c}=n;if(r<a)return{restArrayMerged:c,characters:J(d,p)};const[g,...m]=c;return{restArrayMerged:m,characters:J(d,g||"")}},{restArrayMerged:o,characters:[]}).characters}function Te(t){return t.split("")}const ne=v.forwardRef((t,o)=>{const{value:a,length:n,autoFocus:p,onChange:r,TextFieldsProps:d,onComplete:c,validateChar:g,className:m,...C}=t,{onPaste:O,onFocus:y,onKeyDown:T,className:L,...B}=d||{},R=Re(n,(e,u)=>({character:a[u]||"",inputRef:v.createRef()})),i=e=>R.findIndex(({inputRef:u})=>u.current===e),f=()=>R.map(({character:e})=>e),E=(e,u)=>{const s=Ae(f(),e,u);return z(s)},A=e=>{var u,s;(s=(u=R[e])==null?void 0:u.inputRef.current)==null||s.focus()},I=e=>{var u,s;(s=(u=R[e])==null?void 0:u.inputRef.current)==null||s.select()},U=e=>{e+1!==n&&(R[e+1].character?I(e+1):A(e+1))},re=e=>{e>0&&I(e-1)},oe=e=>{const u=e.target.value[0]||"",s=i(e.target);if(typeof g=="function"&&!g(u,s))return;const h=E(s,u);r==null||r(h),h.length===n&&(c==null||c(h)),u!==""?h.length<n?U(h.length-1):U(s):h[s]?I(s):re(s)},ae=e=>{e.preventDefault(),e.target.select(),y==null||y(e)},ie=e=>{const u=e.target,s=i(u);u.value===e.key?(e.preventDefault(),U(s)):!u.value&&P.backspace===e.key||P.left===e.key?(e.preventDefault(),I(s-1)):P.right===e.key&&(e.preventDefault(),I(s+1)),T==null||T(e)},se=e=>{e.preventDefault();const u=e.target,s=e.clipboardData.getData("text/plain"),h=i(u),ue=f(),q=Se(ue,Te(s),h),W=q.findIndex((le,de)=>de>h&&le===""),F=z(q);if(r==null||r(F),F.length===n){c==null||c(F),A(n-1);return}W!==-1&&A(W),O==null||O(e)};return l(D,{display:"flex",gap:"20px",alignItems:"center",ref:o,className:`MuiOtpInput-Box ${m||""}`,...C,children:R.map(({character:e,inputRef:u},s)=>l(ye,{autoFocus:p?s===0:!1,autoComplete:"one-time-code",value:e,inputRef:u,className:`MuiOtpInput-TextField MuiOtpInput-TextField-${s+1} ${L||""}`,onPaste:se,onFocus:ae,onChange:oe,onKeyDown:ie,...B},s))})});ne.defaultProps={value:"",length:4,autoFocus:!1,validateChar:()=>!0,onChange:()=>{},onComplete:()=>{},TextFieldsProps:{}};const Q=6,Ie=["0","1","2","3","4","5","6","7","8","9"];function M(t){const{onSubmit:o,isLoading:a}=t,[n,p]=v.useState("");return S(D,{children:[l(ne,{autoFocus:!0,length:Q,value:n,onChange:p,onComplete:o,validateChar:r=>Ie.includes(r)||r==="",gap:"2px",sx:{".MuiInputBase-root":{paddingLeft:"5px",paddingRight:"5px"},".MuiFormControl-root:first-of-type > .MuiInputBase-root":{borderTopRightRadius:0,borderBottomRightRadius:0},".MuiFormControl-root:last-of-type > .MuiInputBase-root":{borderTopLeftRadius:0,borderBottomLeftRadius:0},".MuiFormControl-root:not(:first-of-type):not(:last-of-type) > .MuiInputBase-root":{borderRadius:0}}}),l(k,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:n.length!==Q||a,onClick:r=>{r.preventDefault(),o(n)},children:a?"Verifying...":"Submit"})]})}try{M.displayName="TOTPForm",M.__docgenInfo={description:"",displayName:"TOTPForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function x(t){const{resetPasswordUrl:o=`${ee(te.PORTAL_ENDPOINT)}#!PasswordReset:0`,onSubmit:a,isLoading:n}=t,[p,r]=_.useState(""),[d,c]=_.useState("");function g(m){m.preventDefault(),a(p,d)}return S("form",{onSubmit:m=>{g(m)},children:[l(b,{required:!0,fullWidth:!0,autoFocus:!0,autoComplete:"username",label:"Username or Email Address",id:"username",type:"text",value:p,onChange:m=>r(m.target.value)}),l(b,{required:!0,fullWidth:!0,autoComplete:"current-password",label:"Password",id:"current-password",type:"password",value:d,onChange:m=>c(m.target.value)}),l(V,{href:o,children:"Forgot password?"}),l(k,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",disabled:n,sx:{height:"50px",mt:4,mb:2},children:n?"Logging you in...":"Sign in"})]})}try{x.displayName="UsernamePasswordForm",x.__docgenInfo={description:"",displayName:"UsernamePasswordForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(username: string, password: string) => void"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function H(t){const{onBeginOAuthSignIn:o,ssoRedirectUrl:a,onSelectUsernameAndPassword:n}=t;function p(r){o&&o(),r.preventDefault();const d=a?`${a}${N.GOOGLE}`:`${w.getRootURL()}?provider=${N.GOOGLE}`;w.oAuthUrlRequest(N.GOOGLE,d).then(c=>{window.location=c.authorizationUrl}).catch(c=>{console.log("Error on oAuth url ",c)})}return S(D,{children:[l(K,{loginMethod:ce,iconName:"google24",onClick:p}),l(K,{loginMethod:pe,iconName:"email",onClick:n})]})}try{H.displayName="AuthenticationMethodSelection",H.__docgenInfo={description:`To support Google SSO in your portal, you must add your domain to the Authorized Redirect URIs for Synapse authentication.
This can be done by visiting https://sagebionetworks.jira.com/servicedesk/customer/portal/9 to set up a collaboration.
Synapse engineers must add your redirect URL in the Google API console found at https://console.cloud.google.com/ for this functionality to work.`,displayName:"AuthenticationMethodSelection",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},onSelectUsernameAndPassword:{defaultValue:null,description:"",name:"onSelectUsernameAndPassword",required:!0,type:{name:"() => void"}}}}}catch{}const we=19;function G(t){const{onSubmit:o,isLoading:a}=t,[n,p]=v.useState("");return S(D,{children:[l(b,{placeholder:"Enter backup code",value:n,onChange:r=>{const d=r.target.value.toLowerCase().replace(/[^a-z0-9-]/gi,"");p(d)}}),l(k,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:n.length!==we||a,onClick:r=>{r.preventDefault(),o(n)},children:a?"Verifying...":"Submit"})]})}try{G.displayName="RecoveryCodeForm",G.__docgenInfo={description:"",displayName:"RecoveryCodeForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function X(t){const{ssoRedirectUrl:o,registerAccountUrl:a=`${ee(te.PORTAL_ENDPOINT)}#!RegisterAccount:0`,resetPasswordUrl:n,onBeginOAuthSignIn:p,onStepChange:r,step:d,submitUsernameAndPassword:c,submitOneTimePassword:g,errorMessage:m,isLoading:C}=t;return S(j,{children:[d=="CHOOSE_AUTH_METHOD"&&l(H,{onSelectUsernameAndPassword:()=>r("USERNAME_PASSWORD"),onBeginOAuthSignIn:p,ssoRedirectUrl:o}),d==="USERNAME_PASSWORD"&&l(x,{isLoading:C,resetPasswordUrl:n,onSubmit:(O,y)=>{c(O,y)}}),d==="VERIFICATION_CODE"&&S(j,{children:[l(M,{isLoading:C,onSubmit:O=>{g(O,"TOTP")}}),l(V,{align:"center",color:"grey.700",sx:{display:"block",mx:"auto"},onClick:()=>r("RECOVERY_CODE"),children:"Use a backup code instead"})]}),d==="RECOVERY_CODE"&&l(G,{isLoading:C,onSubmit:O=>{g(O,"RECOVERY_CODE")}}),(d==="CHOOSE_AUTH_METHOD"||d==="USERNAME_PASSWORD")&&l(D,{sx:{display:"flex",justifyContent:"center",mt:"10px"},children:l(V,{href:a,align:"center",children:"Don't have an account? Create one now"})}),m&&l(ge,{variant:"warning",isGlobal:!1,description:m})]})}try{X.displayName="LoginForm",X.__docgenInfo={description:"",displayName:"LoginForm",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},registerAccountUrl:{defaultValue:null,description:"",name:"registerAccountUrl",required:!1,type:{name:"string"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},twoFactorAuthenticationRequired:{defaultValue:null,description:"",name:"twoFactorAuthenticationRequired",required:!1,type:{name:"TwoFactorAuthErrorResponse"}},submitUsernameAndPassword:{defaultValue:null,description:"",name:"submitUsernameAndPassword",required:!0,type:{name:"(username: string, password: string) => void"}},submitOneTimePassword:{defaultValue:null,description:"",name:"submitOneTimePassword",required:!0,type:{name:"(code: string, otpType?: TwoFactorAuthOtpType | undefined) => void"}},errorMessage:{defaultValue:null,description:"",name:"errorMessage",required:!0,type:{name:"string | undefined"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function De(t){switch(t){case"CHOOSE_AUTH_METHOD":return"CHOOSE_AUTH_METHOD";case"USERNAME_PASSWORD":return"CHOOSE_AUTH_METHOD";case"VERIFICATION_CODE":return"CHOOSE_AUTH_METHOD";case"RECOVERY_CODE":return"VERIFICATION_CODE";case"LOGGED_IN":return"LOGGED_IN"}}function Z(t){const{step:o,onStepChange:a,sx:n}=t;return o==="USERNAME_PASSWORD"||o==="VERIFICATION_CODE"||o==="RECOVERY_CODE"?l(he,{className:me,type:"button",onClick:()=>{a(De(o))},sx:n,children:l(Ee,{icon:"arrowBack",wrap:!1,sx:{height:"24px",width:"24px"}})}):null}try{Z.displayName="LoginFlowBackButton",Z.__docgenInfo={description:"",displayName:"LoginFlowBackButton",props:{step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},sx:{defaultValue:null,description:"",name:"sx",required:!1,type:{name:"SxProps"}}}}}catch{}export{Z as L,X as a,Ye as u};
//# sourceMappingURL=LoginFlowBackButton-1da94f70.js.map
