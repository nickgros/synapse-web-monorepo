{"version":3,"file":"queryUtils-65153fed.js","sources":["../../src/utils/functions/queryUtils.ts"],"sourcesContent":["import { cloneDeep } from 'lodash-es'\nimport * as SynapseConstants from '../SynapseConstants'\nimport SynapseClient from '../../synapse-client'\nimport { LockedColumn } from '../../components/QueryContext/QueryContext'\nimport {\n  FacetColumnResult,\n  Query,\n  QueryBundleRequest,\n  QueryResultBundle,\n  SelectColumn,\n} from '@sage-bionetworks/synapse-types'\n\nimport {\n  isColumnMultiValueFunctionQueryFilter,\n  isColumnSingleValueQueryFilter,\n} from '../types/IsType'\n\ntype PartialStateObject = {\n  hasMoreData: boolean\n  data: QueryResultBundle\n}\n\n/**\n * Retrieve the index of a column using the column name\n * @param name the column name\n * @param result the QueryResultBundle containing the columns\n * @returns The index of the column, or -1 if the column doesn't exist in the result\n */\nexport const getFieldIndex = (\n  name: string,\n  result: QueryResultBundle | undefined,\n) => {\n  return (\n    result?.selectColumns?.findIndex(el => {\n      return el.name === name\n    }) ?? -1\n  )\n}\n\n/**\n * Grab the next page of data, pulling in 25 more rows.\n *\n * @param {*} queryRequest Query request as specified by\n *                         https://rest-docs.synapse.org/rest/org/sagebionetworks/repo/model/table/Query.html\n */\nexport const getNextPageOfData = async (\n  queryRequest: QueryBundleRequest,\n  data: QueryResultBundle,\n  token?: string,\n) => {\n  return await SynapseClient.getQueryTableResults(queryRequest, token)\n    .then((newData: QueryResultBundle) => {\n      const oldData: QueryResultBundle = cloneDeep(data)!\n      // push on the new data retrieved from the API call\n      const hasMoreData =\n        newData.queryResult!.queryResults.rows.length ===\n          queryRequest.query.limit ?? SynapseConstants.DEFAULT_PAGE_SIZE\n      oldData.queryResult!.queryResults.rows.push(\n        ...newData.queryResult!.queryResults.rows,\n      )\n      const newState: PartialStateObject = {\n        hasMoreData,\n        data: oldData,\n      }\n      return newState\n    })\n    .catch(err => {\n      console.log('Failed to get data ', err)\n      return {} as PartialStateObject\n    })\n}\n\nexport const isFacetAvailable = (\n  facets?: FacetColumnResult[],\n  selectColumns?: SelectColumn[],\n): boolean => {\n  /**\n   *  Facets are available iff\n   *    * there is at least one facet AND\n   *    * each facet has a corresponding columnModel in the selectColumns AND\n   *    * each facets has a valid value other than the null/not set value\n   */\n  if (facets == null || selectColumns == null) {\n    return false\n  }\n\n  if (facets.length === 0 || selectColumns.length === 0) {\n    return false\n  }\n\n  const facetsWithValuesAndColumnModels = facets.filter(facet => {\n    return (\n      !isSingleNotSetValue(facet) &&\n      selectColumns.find(model => model.name === facet.columnName)\n    )\n  })\n\n  return facetsWithValuesAndColumnModels.length > 0\n}\n\nexport const isSingleNotSetValue = (facet: FacetColumnResult): boolean => {\n  return (\n    facet.facetType === 'enumeration' &&\n    facet.facetValues.length == 1 &&\n    facet.facetValues[0].value == SynapseConstants.VALUE_NOT_SET\n  )\n}\n\n// TODO Instead of removing the facet from the data, the facet renderers should just be aware of what to hide\nexport function removeLockedColumnFromFacetData(\n  data?: QueryResultBundle,\n  lockedColumn?: LockedColumn,\n): QueryResultBundle | undefined {\n  const lockedColumnName = lockedColumn?.columnName\n  if (lockedColumnName && data) {\n    // for details page, return data without the \"locked\" facet\n    const dataCopy: QueryResultBundle = cloneDeep(data)\n    const facets = dataCopy.facets?.filter(\n      item => item.columnName.toLowerCase() !== lockedColumnName.toLowerCase(),\n    )\n    dataCopy.facets = facets\n    return dataCopy\n  } else {\n    // for other pages, just return the data\n    return data\n  }\n}\n\n/**\n * Returns true iff the query has filters applied that can be reset.\n * This includes facet filters and additional filters that are not applied to a locked column.\n */\nexport function hasResettableFilters(\n  query: Query,\n  lockedColumn?: LockedColumn,\n): boolean {\n  const hasFacetFilters =\n    Array.isArray(query.selectedFacets) &&\n    query.selectedFacets.filter(\n      facet => facet.columnName !== lockedColumn?.columnName,\n    ).length > 0\n  const hasAdditionalFilters =\n    Array.isArray(query.additionalFilters) &&\n    query.additionalFilters.filter(queryFilter =>\n      isColumnSingleValueQueryFilter(queryFilter) ||\n      isColumnMultiValueFunctionQueryFilter(queryFilter)\n        ? queryFilter.columnName !== lockedColumn?.columnName\n        : true,\n    ).length > 0\n\n  return hasFacetFilters || hasAdditionalFilters\n}\n"],"names":["getFieldIndex","name","result","_a","el","isFacetAvailable","facets","selectColumns","facet","isSingleNotSetValue","model","SynapseConstants.VALUE_NOT_SET","removeLockedColumnFromFacetData","data","lockedColumn","lockedColumnName","dataCopy","cloneDeep","item","hasResettableFilters","query","hasFacetFilters","hasAdditionalFilters","queryFilter","isColumnSingleValueQueryFilter","isColumnMultiValueFunctionQueryFilter"],"mappings":"mLA4Ba,MAAAA,EAAgB,CAC3BC,EACAC,IACG,OAED,QAAAC,EAAAD,GAAA,YAAAA,EAAQ,gBAAR,YAAAC,EAAuB,UAAgBC,GAC9BA,EAAG,OAASH,KACf,EAEV,EAmCaI,EAAmB,CAC9BC,EACAC,IAQID,GAAU,MAAQC,GAAiB,MAInCD,EAAO,SAAW,GAAKC,EAAc,SAAW,EAC3C,GAG+BD,EAAO,OAAgBE,GAE3D,CAACC,EAAoBD,CAAK,GAC1BD,EAAc,KAAcG,GAAAA,EAAM,OAASF,EAAM,UAAU,CAE9D,EAEsC,OAAS,EAGrCC,EAAuBD,GAEhCA,EAAM,YAAc,eACpBA,EAAM,YAAY,QAAU,GAC5BA,EAAM,YAAY,CAAC,EAAE,OAASG,EAKlB,SAAAC,EACdC,EACAC,EAC+B,OAC/B,MAAMC,EAAmBD,GAAA,YAAAA,EAAc,WACvC,GAAIC,GAAoBF,EAAM,CAEtB,MAAAG,EAA8BC,EAAUJ,CAAI,EAC5CP,GAASH,EAAAa,EAAS,SAAT,YAAAb,EAAiB,UACtBe,EAAK,WAAW,YAAY,IAAMH,EAAiB,YAAY,GAEzE,OAAAC,EAAS,OAASV,EACXU,MAGA,QAAAH,CAEX,CAMgB,SAAAM,EACdC,EACAN,EACS,CACT,MAAMO,EACJ,MAAM,QAAQD,EAAM,cAAc,GAClCA,EAAM,eAAe,OACnBZ,GAASA,EAAM,cAAeM,GAAA,YAAAA,EAAc,WAAA,EAC5C,OAAS,EACPQ,EACJ,MAAM,QAAQF,EAAM,iBAAiB,GACrCA,EAAM,kBAAkB,OAAOG,GAC7BC,EAA+BD,CAAW,GAC1CE,EAAsCF,CAAW,EAC7CA,EAAY,cAAeT,GAAA,YAAAA,EAAc,YACzC,EAAA,EACJ,OAAS,EAEb,OAAOO,GAAmBC,CAC5B"}